<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Market Predictor</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root[data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --hero-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: #ffffff;
            --navbar-bg: #ffffff;
            --placeholder-color: #6c757d;
            --form-text-color: #6c757d;
        }
        
        :root[data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #e0e0e0;
            --border-color: #404040;
            --hero-bg: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            --card-bg: #2d2d2d;
            --navbar-bg: #2d2d2d;
            --placeholder-color: #a0a0a0;
            --form-text-color: #a0a0a0;
        }
        
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Roboto', sans-serif;
            transition: all 0.3s ease;
        }
        
        .navbar {
            background-color: var(--navbar-bg) !important;
            border-bottom: 1px solid var(--border-color);
        }
        
        .navbar-brand, .nav-link {
            color: var(--text-primary) !important;
        }
        
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .theme-toggle {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 50px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 10px;
        }
        
        .theme-toggle:hover {
            background-color: var(--bg-secondary);
            transform: scale(1.1);
        }
        
        .hero-section {
            background: var(--hero-bg);
            padding: 60px 0;
            color: white !important;
        }
        
        .hero-section h1, .hero-section p {
            color: white !important;
        }
        
        .form-control {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        
        .form-control:focus {
            background-color: var(--bg-secondary);
            border-color: #667eea;
            color: var(--text-primary);
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .form-control::placeholder {
            color: var(--placeholder-color);
            opacity: 1;
        }
        
        .form-text {
            color: var(--form-text-color) !important;
        }
        
        .btn-primary {
            background: var(--hero-bg);
            border: none;
        }
        
        .chart-container {
            height: 400px;
            position: relative;
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
        }
        
        .technical-chart-container {
            height: 500px;
            position: relative;
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
        }
        
        .ai-chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .ai-chat-toggle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--hero-bg);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .ai-chat-toggle:hover {
            transform: scale(1.1);
        }
        
        .ai-chat-panel {
            position: absolute;
            bottom: 80px;
            right: 0;
            width: 350px;
            height: 500px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none;
            flex-direction: column;
        }
        
        .ai-chat-header {
            background: var(--hero-bg);
            color: white;
            padding: 15px;
            border-radius: 15px 15px 0 0;
            font-weight: 600;
        }
        
        .ai-chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            max-height: 350px;
            background-color: var(--bg-secondary);
        }
        
        .ai-chat-input {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            background-color: var(--card-bg);
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 80%;
        }
        
        .message.user {
            background: #007bff;
            color: white;
            margin-left: auto;
        }
        
        .message.ai {
            background: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .navbar-toggler {
            border-color: var(--border-color);
        }
        
        .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%2833, 37, 41, 0.75%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }
        
        [data-theme="dark"] .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28255, 255, 255, 0.75%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }
        
        .text-muted {
            color: var(--text-secondary) !important;
        }
        
        .bg-light {
            background-color: var(--bg-secondary) !important;
        }
        
        .prediction-card {
            border-left: 4px solid;
        }
        
        .prediction-card.buy {
            border-left-color: #28a745;
        }
        
        .prediction-card.sell {
            border-left-color: #dc3545;
        }
        
        .prediction-card.hold {
            border-left-color: #ffc107;
        }
        
        .loading-spinner {
            text-align: center;
            padding: 2rem;
        }
        
        .stock-item {
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: var(--card-bg);
            transition: all 0.3s ease;
        }
        
        .stock-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .stock-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .quick-predict-btn {
            background: var(--hero-bg);
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .quick-predict-btn:hover {
            transform: scale(1.05);
        }
        
        .chart-type-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--hero-bg);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
            z-index: 10;
        }
        
        .form-select {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        
        .form-select:focus {
            background-color: var(--bg-secondary);
            border-color: #667eea;
            color: var(--text-primary);
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .btn-outline-primary {
            color: #007bff;
            border-color: #007bff;
        }
        
        .btn-outline-primary:hover {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
        }
        
        .btn-outline-primary.active {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
        }
        
        .chart-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px;
            z-index: 10;
            display: flex;
            gap: 5px;
        }
        
        .chart-control-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .chart-control-btn:hover {
            background: var(--hero-bg);
            color: white;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/dashboard">
                <i class="fas fa-chart-line me-2"></i>
                Stock Predictor
            </a>
            <div class="d-flex align-items-center">
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
                <button class="navbar-toggler ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
            </div>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/dashboard">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/portfolio">Portfolio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/news">News</a>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-outline-primary btn-sm ms-2" onclick="logout()">
                            <i class="fas fa-sign-out-alt me-2"></i>Logout
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <h1 class="display-4 fw-bold mb-4">AI-Powered Stock Prediction</h1>
                    <p class="lead mb-4">
                        Get accurate stock price predictions using advanced machine learning algorithms. 
                        Make informed investment decisions with our comprehensive analysis tools.
                    </p>
                </div>
                <div class="col-lg-4 text-center">
                    <i class="fas fa-robot" style="font-size: 6rem; opacity: 0.3;"></i>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <div class="container mt-4">
        <div class="row">
            <div class="col-lg-8">
                <!-- Stock Prediction Form -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-search me-2"></i>
                            Stock Price Prediction
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="predictionForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="stockInput" class="form-label">Stock Symbol or Name</label>
                                    <input type="text" class="form-control" id="stockInput" 
                                           placeholder="e.g., TCS, Reliance, HDFC Bank" required>
                                    <div class="form-text">
                                        Enter stock symbol, company name, or keywords
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="daysAhead" class="form-label">Prediction Period</label>
                                    <select class="form-select" id="daysAhead" required>
                                        <option value="5">5 Days</option>
                                        <option value="10">10 Days</option>
                                        <option value="15">15 Days</option>
                                        <option value="30">30 Days</option>
                                    </select>
                                </div>
                                <div class="col-md-2 mb-3 d-flex align-items-end">
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-magic me-2"></i>Predict
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Prediction Results -->
                <div id="predictionResults" style="display: none;">
                    <div class="card prediction-card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0" id="resultTitle">Prediction Results</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="text-center">
                                        <h6 class="text-muted">Current Price</h6>
                                        <div class="h2" id="currentPrice">₹0.00</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="text-center">
                                        <h6 class="text-muted">Predicted Price</h6>
                                        <div class="h2" id="predictedPrice">₹0.00</div>
                                        <small id="priceChange" class="text-muted"></small>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-4 text-center">
                                    <h6 class="text-muted">Recommendation</h6>
                                    <span class="badge fs-6" id="recommendation">HOLD</span>
                                </div>
                                <div class="col-md-4 text-center">
                                    <h6 class="text-muted">Confidence</h6>
                                    <div class="h5" id="confidence">0%</div>
                                </div>
                                <div class="col-md-4 text-center">
                                    <button class="btn btn-outline-primary" onclick="calibrateModel()">
                                        <i class="fas fa-cog me-2"></i>Calibrate Model
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Price Chart -->
                <div id="chartSection" class="card mb-4" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-area me-2"></i>
                            Price Movement & Prediction
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="priceChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Technical Analysis Charts -->
                <div id="technicalChartsSection" class="card mb-4" style="display: none;">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>
                            Technical Analysis Charts
                        </h5>
                        <div class="d-flex gap-2">
                            <select class="form-select form-select-sm" id="chartTypeSelect" style="width: auto;">
                                <option value="candlestick">Candlestick</option>
                                <option value="renko">Renko</option>
                                <option value="kagi">Kagi</option>
                                <option value="point_figure">Point & Figure</option>
                                <option value="breakout">Breakout</option>
                            </select>
                            <select class="form-select form-select-sm" id="chartPeriodSelect" style="width: auto;">
                                <option value="1mo">1 Month</option>
                                <option value="3mo" selected>3 Months</option>
                                <option value="6mo">6 Months</option>
                                <option value="1y">1 Year</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="technical-chart-container">
                            <div class="chart-type-indicator" id="chartTypeIndicator">Candlestick</div>
                            <div class="chart-controls">
                                <button class="chart-control-btn" onclick="resetChartZoom()" title="Reset Zoom">
                                    <i class="fas fa-home"></i>
                                </button>
                                <button class="chart-control-btn" onclick="zoomIn()" title="Zoom In">
                                    <i class="fas fa-search-plus"></i>
                                </button>
                                <button class="chart-control-btn" onclick="zoomOut()" title="Zoom Out">
                                    <i class="fas fa-search-minus"></i>
                                </button>
                                <button class="chart-control-btn" onclick="panLeft()" title="Pan Left">
                                    <i class="fas fa-arrow-left"></i>
                                </button>
                                <button class="chart-control-btn" onclick="panRight()" title="Pan Right">
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                            <canvas id="technicalChart"></canvas>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h6>Technical Indicators</h6>
                                <div id="technicalIndicators">
                                    <div class="loading-spinner">
                                        <div class="spinner-border spinner-border-sm" role="status"></div>
                                        <span class="ms-2">Loading indicators...</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Chart Patterns</h6>
                                <div id="chartPatterns">
                                    <div class="loading-spinner">
                                        <div class="spinner-border spinner-border-sm" role="status"></div>
                                        <span class="ms-2">Analyzing patterns...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Top Performing Stocks -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-star me-2"></i>
                            Top Performing Stocks
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Stock Controls -->
                        <div class="stock-controls">
                            <div class="w-100 mb-2">
                                <label class="form-label text-muted small">Category:</label>
                                <div class="d-grid gap-1">
                                    <button class="btn btn-outline-primary btn-sm category-btn active" data-category="safe">
                                        Safe Stocks
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm category-btn" data-category="volatile">
                                        Volatile Stocks
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm category-btn" data-category="highly_volatile">
                                        High Risk/Reward
                                    </button>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-6">
                                    <label for="stockCount" class="form-label text-muted small">Number of Stocks:</label>
                                    <select class="form-select form-select-sm" id="stockCount">
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5" selected>5</option>
                                        <option value="6">6</option>
                                        <option value="7">7</option>
                                        <option value="8">8</option>
                                        <option value="9">9</option>
                                        <option value="10">10</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label for="timePeriod" class="form-label text-muted small">Time Period (Days):</label>
                                    <input type="number" class="form-control form-control-sm" id="timePeriod" 
                                           min="1" max="30" value="5" placeholder="1-30">
                                </div>
                            </div>
                        </div>
                        
                        <div id="topStocksList">
                            <div class="loading-spinner">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <span class="ms-2">Loading stocks...</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Market Summary -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>
                            Market Summary
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="text-center">
                            <div class="mb-3">
                                <h6>NIFTY 50</h6>
                                <div class="h4 text-success">19,674.25</div>
                                <small class="text-success">+124.35 (+0.64%)</small>
                            </div>
                            <div class="mb-3">
                                <h6>SENSEX</h6>
                                <div class="h4 text-success">65,834.69</div>
                                <small class="text-success">+389.75 (+0.60%)</small>
                            </div>
                            <div>
                                <h6>FII Investment</h6>
                                <div class="h6 text-primary">₹2,456 Cr</div>
                                <small class="text-muted">Net buying today</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Chat Assistant -->
    <div class="ai-chat-container">
        <div class="ai-chat-panel" id="aiChatPanel">
            <div class="ai-chat-header">
                <div class="d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-robot me-2"></i>AI Investment Assistant</span>
                    <button class="btn btn-sm text-white" onclick="toggleAIChat()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="ai-chat-messages" id="aiChatMessages">
                <div class="message ai">
                    <strong>AI Assistant:</strong> Hello! I can help you understand stock predictions, explain technical indicators, and provide investment guidance. Ask me anything!
                </div>
            </div>
            <div class="ai-chat-input">
                <form id="aiChatForm">
                    <div class="input-group">
                        <input type="text" class="form-control" id="aiChatInput" placeholder="Ask me about stocks...">
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <button class="ai-chat-toggle" onclick="toggleAIChat()" title="AI Assistant">
            <i class="fas fa-comments"></i>
        </button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom/dist/chartjs-plugin-zoom.min.js"></script>
    
    <script>
        let currentStockSymbol = '';
        let priceChart;
        let technicalChart;
        let currentChartType = 'candlestick';
        let currentChartData = null;

        // Theme Management
        function toggleTheme() {
            const html = document.documentElement;
            const themeIcon = document.getElementById('themeIcon');
            
            if (html.getAttribute('data-theme') === 'light') {
                html.setAttribute('data-theme', 'dark');
                themeIcon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'dark');
            } else {
                html.setAttribute('data-theme', 'light');
                themeIcon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'light');
            }
        }

        // Load saved theme
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const themeIcon = document.getElementById('themeIcon');
            
            document.documentElement.setAttribute('data-theme', savedTheme);
            themeIcon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            
            // Load top stocks
            loadTopStocks();
            
            // Setup category buttons
            setupCategoryButtons();
            
            // Setup chart controls
            setupChartControls();
            
            // Setup stock controls
            setupStockControls();
        });

        // Prediction Form Handler
        document.getElementById('predictionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const stockInput = document.getElementById('stockInput').value.trim();
            const daysAhead = document.getElementById('daysAhead').value;
            
            if (!stockInput) return;
            
            try {
                // Show loading
                showLoading('Analyzing stock and generating prediction...');
                
                // Search for stock first
                const searchResponse = await fetch('/api/search-stock', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ input: stockInput })
                });
                
                const searchData = await searchResponse.json();
                let symbol = searchData.found ? searchData.symbol : stockInput.toUpperCase();
                
                // Get prediction
                const response = await fetch('/api/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        symbol: symbol,
                        days_ahead: parseInt(daysAhead)
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                currentStockSymbol = data.symbol;
                displayPrediction(data);
                
                // Load technical charts
                loadTechnicalCharts(data.symbol);
                
                hideLoading();
                
            } catch (error) {
                console.error('Prediction error:', error);
                hideLoading();
                alert('Error generating prediction: ' + error.message);
            }
        });

        function displayPrediction(data) {
            // Update prediction results
            document.getElementById('resultTitle').textContent = `${data.name} (${data.symbol}) - ${data.days_ahead} Day Prediction`;
            document.getElementById('currentPrice').textContent = `₹${data.current_price}`;
            document.getElementById('predictedPrice').textContent = `₹${data.predicted_price}`;
            
            const changeText = data.price_change_pct >= 0 ? 
                `+${data.price_change_pct}%` : `${data.price_change_pct}%`;
            const changeClass = data.price_change_pct >= 0 ? 'text-success' : 'text-danger';
            
            document.getElementById('priceChange').textContent = changeText;
            document.getElementById('priceChange').className = `text-muted ${changeClass}`;
            
            // Update recommendation
            const recommendation = document.getElementById('recommendation');
            recommendation.textContent = data.recommendation;
            recommendation.className = `badge fs-6 ${getRecommendationClass(data.recommendation)}`;
            
            document.getElementById('confidence').textContent = `${data.confidence}%`;
            
            // Update prediction card class
            const predictionCard = document.querySelector('.prediction-card');
            predictionCard.className = `card prediction-card mb-4 ${getRecommendationClass(data.recommendation).replace('bg-', '')}`;
            
            // Show results
            document.getElementById('predictionResults').style.display = 'block';
            
            // Create price chart
            createPriceChart(data.historical_data, data.prediction_data);
            document.getElementById('chartSection').style.display = 'block';
        }

        function getRecommendationClass(recommendation) {
            switch(recommendation.toLowerCase()) {
                case 'buy':
                case 'strong buy':
                    return 'bg-success';
                case 'sell':
                case 'strong sell':
                    return 'bg-danger';
                default:
                    return 'bg-warning';
            }
        }

        function createPriceChart(historicalData, predictionData) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (priceChart) {
                priceChart.destroy();
            }
            
            const allData = [...historicalData, ...predictionData];
            const labels = allData.map(d => d.date);
            const predictionStart = historicalData.length;
            
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Historical Price',
                        data: historicalData.map(d => d.price),
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.1,
                        fill: true
                    }, {
                        label: 'Predicted Price',
                        data: [...Array(predictionStart).fill(null), ...predictionData.map(d => d.price)],
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        borderDash: [5, 5],
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        zoom: {
                            zoom: {
                                wheel: {
                                    enabled: true,
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x',
                            },
                            pan: {
                                enabled: true,
                                mode: 'x',
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ₹${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Price (₹)'
                            }
                        }
                    }
                }
            });
        }

        async function loadTechnicalCharts(symbol) {
            try {
                const chartType = document.getElementById('chartTypeSelect').value;
                const period = document.getElementById('chartPeriodSelect').value;
                
                const response = await fetch(`/api/technical-chart/${symbol}?type=${chartType}&period=${period}`);
                const data = await response.json();
                
                if (data.success) {
                    currentChartData = data;
                    currentChartType = chartType;
                    createTechnicalChart(data);
                    displayTechnicalIndicators(data.indicators);
                    displayChartPatterns(data.patterns);
                    document.getElementById('technicalChartsSection').style.display = 'block';
                    
                    // Update chart type indicator
                    document.getElementById('chartTypeIndicator').textContent = getChartTypeDisplayName(chartType);
                } else {
                    console.error('Failed to load technical charts:', data.error);
                }
                
            } catch (error) {
                console.error('Error loading technical charts:', error);
            }
        }

        function getChartTypeDisplayName(type) {
            const displayNames = {
                'candlestick': 'Candlestick',
                'renko': 'Renko',
                'kagi': 'Kagi',
                'point_figure': 'Point & Figure',
                'breakout': 'Breakout'
            };
            return displayNames[type] || type;
        }

        function createTechnicalChart(data) {
            const ctx = document.getElementById('technicalChart').getContext('2d');
            
            if (technicalChart) {
                technicalChart.destroy();
            }
            
            const chartData = data.data;
            const labels = chartData.map(d => d.date);
            
            let datasets = [];
            
            // Create different chart types
            switch (data.chart_type) {
                case 'candlestick':
                    datasets = createCandlestickDatasets(chartData);
                    break;
                case 'renko':
                    datasets = createRenkoDatasets(chartData);
                    break;
                case 'kagi':
                    datasets = createKagiDatasets(chartData);
                    break;
                case 'point_figure':
                    datasets = createPointFigureDatasets(chartData);
                    break;
                case 'breakout':
                    datasets = createBreakoutDatasets(chartData);
                    break;
                default:
                    datasets = createCandlestickDatasets(chartData);
            }
            
            technicalChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        zoom: {
                            zoom: {
                                wheel: {
                                    enabled: true,
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'xy',
                            },
                            pan: {
                                enabled: true,
                                mode: 'xy',
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const dataPoint = chartData[index];
                                    
                                    if (data.chart_type === 'candlestick' && dataPoint.open !== undefined) {
                                        return [
                                            `Open: ₹${dataPoint.open}`,
                                            `High: ₹${dataPoint.high}`,
                                            `Low: ₹${dataPoint.low}`,
                                            `Close: ₹${dataPoint.close}`,
                                            `Volume: ${dataPoint.volume?.toLocaleString() || 'N/A'}`
                                        ];
                                    } else {
                                        return `${context.dataset.label}: ₹${context.parsed.y.toFixed(2)}`;
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Price (₹)'
                            }
                        }
                    }
                }
            });
        }

        function createCandlestickDatasets(chartData) {
            return [{
                label: 'High',
                data: chartData.map(d => d.high),
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.1,
                pointRadius: 0,
                fill: '+1'
            }, {
                label: 'Low',
                data: chartData.map(d => d.low),
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.1,
                pointRadius: 0,
                fill: false
            }, {
                label: 'Close',
                data: chartData.map(d => d.close),
                borderColor: '#007bff',
                backgroundColor: 'transparent',
                tension: 0.1,
                pointRadius: 1,
                borderWidth: 2,
                fill: false
            }];
        }

        function createRenkoDatasets(chartData) {
            const upBricks = [];
            const downBricks = [];
            
            chartData.forEach((d, i) => {
                if (d.direction === 1) {
                    upBricks.push(d.close);
                    downBricks.push(null);
                } else {
                    upBricks.push(null);
                    downBricks.push(d.close);
                }
            });
            
            return [{
                label: 'Up Bricks',
                data: upBricks,
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.3)',
                stepped: true,
                fill: false
            }, {
                label: 'Down Bricks',
                data: downBricks,
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.3)',
                stepped: true,
                fill: false
            }];
        }

        function createKagiDatasets(chartData) {
            const prices = chartData.map(d => d.price);
            return [{
                label: 'Kagi Line',
                data: prices,
                borderColor: '#007bff',
                backgroundColor: 'transparent',
                tension: 0,
                pointRadius: 2,
                borderWidth: 2,
                fill: false
            }];
        }

        function createPointFigureDatasets(chartData) {
            const xData = [];
            const oData = [];
            
            chartData.forEach((d, i) => {
                if (d.type === 'X') {
                    xData.push(d.price);
                    oData.push(null);
                } else {
                    xData.push(null);
                    oData.push(d.price);
                }
            });
            
            return [{
                label: 'X Column',
                data: xData,
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.3)',
                pointStyle: 'cross',
                pointRadius: 5,
                showLine: false
            }, {
                label: 'O Column',
                data: oData,
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.3)',
                pointStyle: 'circle',
                pointRadius: 5,
                showLine: false
            }];
        }

        function createBreakoutDatasets(chartData) {
            return [{
                label: 'Price',
                data: chartData.map(d => d.price),
                borderColor: '#007bff',
                backgroundColor: 'transparent',
                tension: 0.1,
                pointRadius: 1,
                fill: false
            }, {
                label: 'Resistance',
                data: chartData.map(d => d.resistance),
                borderColor: '#dc3545',
                backgroundColor: 'transparent',
                borderDash: [5, 5],
                tension: 0,
                pointRadius: 0,
                fill: false
            }, {
                label: 'Support',
                data: chartData.map(d => d.support),
                borderColor: '#28a745',
                backgroundColor: 'transparent',
                borderDash: [5, 5],
                tension: 0,
                pointRadius: 0,
                fill: false
            }];
        }

        function displayTechnicalIndicators(indicators) {
            const container = document.getElementById('technicalIndicators');
            
            let html = '<div class="row">';
            
            if (indicators.rsi !== null) {
                const rsiClass = indicators.rsi > 70 ? 'bg-danger' : indicators.rsi < 30 ? 'bg-success' : 'bg-secondary';
                const rsiText = indicators.rsi > 70 ? 'Overbought' : indicators.rsi < 30 ? 'Oversold' : 'Neutral';
                html += `
                    <div class="col-12 mb-2">
                        <small class="text-muted">RSI (14):</small>
                        <div class="d-flex justify-content-between">
                            <span>${indicators.rsi}</span>
                            <span class="badge ${rsiClass}">${rsiText}</span>
                        </div>
                    </div>
                `;
            }
            
            if (indicators.macd !== null) {
                html += `
                    <div class="col-12 mb-2">
                        <small class="text-muted">MACD:</small>
                        <div class="d-flex justify-content-between">
                            <span>₹${indicators.macd}</span>
                            <span class="badge ${indicators.macd > 0 ? 'bg-success' : 'bg-danger'}">${indicators.macd > 0 ? 'Bullish' : 'Bearish'}</span>
                        </div>
                    </div>
                `;
            }
            
            if (indicators.sma_20 !== null) {
                html += `
                    <div class="col-12 mb-2">
                        <small class="text-muted">SMA (20):</small>
                        <div>₹${indicators.sma_20}</div>
                    </div>
                `;
            }
            
            if (indicators.bb_upper !== null && indicators.bb_lower !== null) {
                html += `
                    <div class="col-12 mb-2">
                        <small class="text-muted">Bollinger Bands:</small>
                        <div>Upper: ₹${indicators.bb_upper}</div>
                        <div>Lower: ₹${indicators.bb_lower}</div>
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function displayChartPatterns(patterns) {
            const container = document.getElementById('chartPatterns');
            
            let html = '<div class="row">';
            
            if (patterns.detected_patterns && patterns.detected_patterns.length > 0) {
                html += `
                    <div class="col-12 mb-2">
                        <small class="text-muted">Detected Patterns:</small>
                        <div>
                            ${patterns.detected_patterns.map(pattern => 
                                `<span class="badge bg-info me-1">${pattern}</span>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (patterns.support_levels && patterns.support_levels.length > 0) {
                html += `
                    <div class="col-12 mb-2">
                        <small class="text-muted">Support Levels:</small>
                        <div>
                            ${patterns.support_levels.map(level => 
                                `<span class="badge bg-success me-1">₹${level}</span>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (patterns.resistance_levels && patterns.resistance_levels.length > 0) {
                html += `
                    <div class="col-12 mb-2">
                        <small class="text-muted">Resistance Levels:</small>
                        <div>
                            ${patterns.resistance_levels.map(level => 
                                `<span class="badge bg-danger me-1">₹${level}</span>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function setupChartControls() {
            document.getElementById('chartTypeSelect').addEventListener('change', function() {
                if (currentStockSymbol) {
                    loadTechnicalCharts(currentStockSymbol);
                }
            });
            
            document.getElementById('chartPeriodSelect').addEventListener('change', function() {
                if (currentStockSymbol) {
                    loadTechnicalCharts(currentStockSymbol);
                }
            });
        }

        // Chart Control Functions
        function resetChartZoom() {
            if (technicalChart) {
                technicalChart.resetZoom();
            }
        }

        function zoomIn() {
            if (technicalChart) {
                technicalChart.zoom(1.1);
            }
        }

        function zoomOut() {
            if (technicalChart) {
                technicalChart.zoom(0.9);
            }
        }

        function panLeft() {
            if (technicalChart) {
                technicalChart.pan({x: -50}, undefined, 'default');
            }
        }

        function panRight() {
            if (technicalChart) {
                technicalChart.pan({x: 50}, undefined, 'default');
            }
        }

        async function calibrateModel() {
            if (!currentStockSymbol) return;
            
            try {
                showLoading('Calibrating prediction model...');
                
                const response = await fetch('/api/calibrate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        symbol: currentStockSymbol,
                        days_ahead: parseInt(document.getElementById('daysAhead').value)
                    })
                });
                
                const data = await response.json();
                
                hideLoading();
                
                if (data.error) {
                    alert('Calibration failed: ' + data.error);
                } else {
                    alert(`Model calibrated! Accuracy: ${data.accuracy_score.toFixed(2)}%`);
                }
                
            } catch (error) {
                hideLoading();
                alert('Calibration failed: ' + error.message);
            }
        }

        // Top Stocks Management
        function setupCategoryButtons() {
            const buttons = document.querySelectorAll('.category-btn');
            
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all buttons
                    buttons.forEach(btn => btn.classList.remove('active'));
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    loadTopStocks();
                });
            });
        }

        function setupStockControls() {
            document.getElementById('stockCount').addEventListener('change', loadTopStocks);
            document.getElementById('timePeriod').addEventListener('change', loadTopStocks);
        }

        async function loadTopStocks() {
            try {
                const container = document.getElementById('topStocksList');
                container.innerHTML = `
                    <div class="loading-spinner">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        <span class="ms-2">Loading stocks...</span>
                    </div>
                `;
                
                const category = document.querySelector('.category-btn.active').dataset.category;
                const count = document.getElementById('stockCount').value;
                const timePeriod = document.getElementById('timePeriod').value;
                
                const response = await fetch(`/api/top-stocks?category=${category}&count=${count}&time_period=${timePeriod}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                displayTopStocks(data.stocks, data.time_period);
                
            } catch (error) {
                document.getElementById('topStocksList').innerHTML = `
                    <div class="text-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span class="ms-2">Failed to load stocks</span>
                    </div>
                `;
                console.error('Error loading top stocks:', error);
            }
        }

        function displayTopStocks(stocks, timePeriod) {
            const container = document.getElementById('topStocksList');
            
            const stocksHTML = stocks.map(stock => `
                <div class="stock-item">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <div class="fw-bold">${stock.symbol}</div>
                            <small class="text-muted">${stock.name}</small>
                        </div>
                        <button class="quick-predict-btn" onclick="quickPredict('${stock.symbol}')">
                            <i class="fas fa-bolt"></i> Quick Predict
                        </button>
                    </div>
                    
                    <div class="row text-center">
                        <div class="col-6">
                            <small class="text-muted">Current Price</small>
                            <div class="fw-bold">₹${stock.current_price}</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Predicted Price</small>
                            <div class="fw-bold text-${stock.predicted_change >= 0 ? 'success' : 'danger'}">
                                ₹${stock.predicted_price}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row text-center mt-2">
                        <div class="col-6">
                            <small class="text-muted">${timePeriod}D Change</small>
                            <div class="small ${stock.price_change >= 0 ? 'text-success' : 'text-danger'}">
                                ${stock.price_change >= 0 ? '+' : ''}${stock.price_change.toFixed(2)}%
                            </div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Predicted Change</small>
                            <div class="small ${stock.predicted_change >= 0 ? 'text-success' : 'text-danger'}">
                                ${stock.predicted_change >= 0 ? '+' : ''}${stock.predicted_change.toFixed(2)}%
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-2">
                        <small class="text-muted">${stock.sector}</small>
                        <small class="text-primary">${stock.prediction_confidence}% confidence</small>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = stocksHTML;
        }

        async function quickPredict(symbol) {
            try {
                // Fill the main prediction form
                document.getElementById('stockInput').value = symbol;
                
                // Trigger prediction
                document.getElementById('predictionForm').dispatchEvent(new Event('submit'));
                
                // Scroll to results
                setTimeout(() => {
                    document.getElementById('predictionResults').scrollIntoView({ 
                        behavior: 'smooth' 
                    });
                }, 1000);
                
            } catch (error) {
                console.error('Quick predict error:', error);
                alert('Error with quick prediction: ' + error.message);
            }
        }

        // AI Chat Functions
        function toggleAIChat() {
            const panel = document.getElementById('aiChatPanel');
            if (panel.style.display === 'none' || panel.style.display === '') {
                panel.style.display = 'flex';
            } else {
                panel.style.display = 'none';
            }
        }

        // AI Chat Form Handler
        document.getElementById('aiChatForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const input = document.getElementById('aiChatInput');
            const question = input.value.trim();
            
            if (!question) return;
            
            // Add user message
            addChatMessage(question, 'user');
            input.value = '';
            
            // Show typing indicator
            const messagesContainer = document.getElementById('aiChatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ai typing';
            typingDiv.innerHTML = '<em>AI is typing...</em>';
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            try {
                const response = await fetch('/api/ai-assistant', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ question })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Remove typing indicator
                typingDiv.remove();
                
                // Add AI response
                addChatMessage(data.response || 'Sorry, I could not generate a response.', 'ai');
                
            } catch (error) {
                typingDiv.remove();
                addChatMessage('Sorry, I encountered an error. Please try again.', 'ai');
                console.error('AI Chat error:', error);
            }
        });

        function addChatMessage(message, sender) {
            const messagesContainer = document.getElementById('aiChatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            if (sender === 'ai') {
                // Convert markdown-like formatting to HTML
                const formattedMessage = message
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/\n/g, '<br>');
                messageDiv.innerHTML = formattedMessage;
            } else {
                messageDiv.textContent = message;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Utility Functions
        function showLoading(message) {
            console.log('Loading:', message);
            // You can implement a loading overlay here if needed
        }

        function hideLoading() {
            console.log('Loading complete');
        }

        // Logout function
        async function logout() {
            try {
                const response = await fetch('/api/logout', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (response.ok) {
                    window.location.href = '/';
                } else {
                    console.error('Logout failed');
                }
            } catch (error) {
                console.error('Logout failed:', error);
                // Still redirect on error
                window.location.href = '/';
            }
        }
    </script>
</body>
</html>
