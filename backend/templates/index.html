<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Market Predictor</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root[data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --hero-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: #ffffff;
            --navbar-bg: #ffffff;
            --placeholder-color: #6c757d;
            --form-text-color: #6c757d;
        }
        
        :root[data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #e0e0e0;
            --border-color: #404040;
            --hero-bg: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            --card-bg: #2d2d2d;
            --navbar-bg: #2d2d2d;
            --placeholder-color: #a0a0a0;
            --form-text-color: #a0a0a0;
        }
        
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Roboto', sans-serif;
            transition: all 0.3s ease;
        }
        
        .navbar {
            background-color: var(--navbar-bg) !important;
            border-bottom: 1px solid var(--border-color);
        }
        
        .navbar-brand, .nav-link {
            color: var(--text-primary) !important;
        }
        
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .theme-toggle {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 50px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 10px;
        }
        
        .theme-toggle:hover {
            background-color: var(--bg-secondary);
            transform: scale(1.1);
        }
        
        .hero-section {
            background: var(--hero-bg);
            padding: 60px 0;
            color: white !important;
        }
        
        .hero-section h1, .hero-section p {
            color: white !important;
        }
        
        .form-control {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        
        .form-control:focus {
            background-color: var(--bg-secondary);
            border-color: #667eea;
            color: var(--text-primary);
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .form-control::placeholder {
            color: var(--placeholder-color);
            opacity: 1;
        }
        
        .form-text {
            color: var(--form-text-color) !important;
        }
        
        .btn-primary {
            background: var(--hero-bg);
            border: none;
        }
        
        .chart-container {
            height: 400px;
            position: relative;
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
        }
        
        .technical-chart-container {
            height: 500px;
            position: relative;
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
        }
        
        .ai-chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .ai-chat-toggle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--hero-bg);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .ai-chat-toggle:hover {
            transform: scale(1.1);
        }
        
        .ai-chat-panel {
            position: absolute;
            bottom: 80px;
            right: 0;
            width: 350px;
            height: 500px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none;
            flex-direction: column;
        }

        /* Responsive adjustments */
        @media (max-width: 992px) {
            .ai-chat-panel {
                position: fixed;
                right: 10px;
                left: 10px;
                bottom: 90px;
                width: auto;
                height: 55vh;
            }
            .technical-chart-container { height: 380px; }
            .chart-container { height: 320px; }
        }
        @media (max-width: 576px) {
            .hero-section { padding: 32px 0; }
            .ai-chat-toggle { width: 54px; height: 54px; font-size: 20px; }
            .ai-chat-panel { height: 60vh; }
            .navbar .btn { padding: 4px 8px; }
        }
        
        .ai-chat-header {
            background: var(--hero-bg);
            color: white;
            padding: 15px;
            border-radius: 15px 15px 0 0;
            font-weight: 600;
        }
        
        .ai-chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            max-height: 350px;
            background-color: var(--bg-secondary);
        }
        
        .ai-chat-input {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            background-color: var(--card-bg);
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 80%;
        }
        
        .message.user {
            background: #007bff;
            color: white;
            margin-left: auto;
        }
        
        .message.ai {
            background: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .navbar-toggler {
            border-color: var(--border-color);
        }
        
        .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%2833, 37, 41, 0.75%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }
        
        [data-theme="dark"] .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28255, 255, 255, 0.75%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }
        
        .text-muted {
            color: var(--text-secondary) !important;
        }
        
        .bg-light {
            background-color: var(--bg-secondary) !important;
        }
        
        .prediction-card {
            border-left: 4px solid;
        }
        
        .prediction-card.buy {
            border-left-color: #28a745;
        }
        
        .prediction-card.sell {
            border-left-color: #dc3545;
        }
        
        .prediction-card.hold {
            border-left-color: #ffc107;
        }
        
        .loading-spinner {
            text-align: center;
            padding: 2rem;
        }
        
        .stock-item {
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: var(--card-bg);
            transition: all 0.3s ease;
        }
        
        .stock-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .stock-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .quick-predict-btn {
            background: var(--hero-bg);
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .quick-predict-btn:hover {
            transform: scale(1.05);
        }
        
        .chart-type-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--hero-bg);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
            z-index: 10;
        }
        
        .form-select {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        
        .form-select:focus {
            background-color: var(--bg-secondary);
            border-color: #667eea;
            color: var(--text-primary);
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .btn-outline-primary {
            color: #007bff;
            border-color: #007bff;
        }
        
        .btn-outline-primary:hover {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
        }
        
        .btn-outline-primary.active {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
        }
        
        .chart-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px;
            z-index: 10;
            display: flex;
            gap: 5px;
        }
        
        .chart-control-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .chart-control-btn:hover {
            background: var(--hero-bg);
            color: white;
        }

        .info-tooltip {
            position: relative;
            cursor: help;
        }
        
        .tooltip-content {
            visibility: hidden;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 12px;
            width: 200px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .info-tooltip:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
        }
        
        .tooltip-content::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        /* Voice Feature Styles */
        .voice-activity-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            display: none;
        }

        .pulse-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border: 3px solid #007bff;
            border-radius: 50%;
            animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }

        .pulse-ring:nth-child(2) {
            animation-delay: 0.5s;
        }

        .pulse-ring:nth-child(3) {
            animation-delay: 1s;
        }

        @keyframes pulse-ring {
            0% {
                transform: translate(-50%, -50%) scale(0.33);
                opacity: 1;
            }
            80%, 100% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 0;
            }
        }

        .interim-transcript {
            background: rgba(0, 123, 255, 0.1);
            border: 1px solid rgba(0, 123, 255, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            margin: 5px 0;
            font-style: italic;
            color: #007bff;
            transition: opacity 0.3s ease;
        }

        .voice-settings-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            width: 400px;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
        }

        .voice-settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: 12px 12px 0 0;
        }

        .voice-settings-header h6 {
            margin: 0;
            color: var(--text-primary);
            font-weight: 600;
        }

        .voice-settings-content {
            padding: 20px;
        }

        .voice-settings-panel .form-label {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .voice-settings-panel .form-range {
            margin-top: 5px;
        }

        .voice-settings-panel .form-check-label {
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        /* Voice button animations */
        .btn[title*="voice"] {
            transition: all 0.3s ease;
        }

        .btn[title*="voice"]:hover {
            transform: scale(1.05);
        }

        .btn[title*="voice"].btn-primary {
            animation: voice-active 2s ease-in-out infinite;
        }

        @keyframes voice-active {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(0, 123, 255, 0);
            }
        }

        /* Voice command feedback */
        .voice-command-feedback {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            z-index: 9998;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Dark theme voice styles */
        [data-theme="dark"] .voice-settings-panel {
            background: var(--bg-primary);
            border-color: var(--border-color);
        }

        [data-theme="dark"] .voice-settings-header {
            background: var(--bg-secondary);
            border-color: var(--border-color);
        }

        [data-theme="dark"] .interim-transcript {
            background: rgba(0, 123, 255, 0.2);
            border-color: rgba(0, 123, 255, 0.4);
        }

        /* Mobile responsive voice styles */
        @media (max-width: 768px) {
            .voice-settings-panel {
                width: 95vw;
                margin: 10px;
            }
            
            .voice-activity-indicator {
                top: 40%;
            }
            
            .pulse-ring {
                width: 50px;
                height: 50px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/dashboard">
                <i class="fas fa-chart-line me-2"></i>
                Stock Predictor
            </a>
            <div class="d-flex align-items-center">
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
                <button class="navbar-toggler ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
            </div>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/dashboard">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/portfolio">Portfolio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/news">News</a>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-outline-primary btn-sm ms-2" onclick="logout()">
                            <i class="fas fa-sign-out-alt me-2"></i>Logout
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <h1 class="display-4 fw-bold mb-4">AI-Powered Stock Prediction</h1>
                    <p class="lead mb-4">
                        Get accurate stock price predictions using advanced machine learning algorithms. 
                        Make informed investment decisions with our comprehensive analysis tools.
                    </p>
                </div>
                <div class="col-lg-4 text-center">
                    <i class="fas fa-robot" style="font-size: 6rem; opacity: 0.3;"></i>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <div class="container mt-4">
        <div class="row">
            <div class="col-lg-8">
                <!-- Stock Prediction Form -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-search me-2"></i>
                            Stock Price Prediction
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="predictionForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="stockInput" class="form-label">Stock Symbol or Name</label>
                                    <input type="text" class="form-control" id="stockInput" 
                                           placeholder="e.g., TCS, Reliance, HDFC Bank" required>
                                    <div class="form-text">
                                        Enter stock symbol, company name, or keywords
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="predictionDays" class="form-label">Prediction Period</label>
                                    <select class="form-select" id="predictionDays" required>
                                        <option value="5">5 Days</option>
                                        <option value="10">10 Days</option>
                                        <option value="15">15 Days</option>
                                        <option value="30">30 Days</option>
                                    </select>
                                </div>
                                <div class="col-md-2 mb-3 d-flex align-items-end">
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-magic me-2"></i>Predict
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="predictionLoading" style="display: none;">
                    <div class="card mb-4">
                        <div class="card-body text-center">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <h5>Analyzing Stock Data...</h5>
                            <p class="text-muted">Our AI is processing market data, technical indicators, and sentiment analysis.</p>
                        </div>
                    </div>
                </div>

                <!-- Initial State -->
                <div id="predictionInitial">
                    <div class="card mb-4">
                        <div class="card-body text-center py-5">
                            <i class="fas fa-chart-line text-muted" style="font-size: 3rem;"></i>
                            <h5 class="mt-3">Enter a stock symbol above to get started</h5>
                            <p class="text-muted">Get AI-powered predictions, technical analysis, and comprehensive insights</p>
                        </div>
                    </div>
                </div>

                <!-- Prediction Results -->
                <div id="predictionResults" class="d-none">
                    <div class="card prediction-card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0" id="stockName">Prediction Results</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="text-center">
                                        <h6 class="text-muted">Current Price</h6>
                                        <div class="h2" id="currentPrice">₹0.00</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="text-center">
                                        <h6 class="text-muted">Predicted Price <span id="predictionPeriodLabel">(5-day)</span></h6>
                                        <div class="h2" id="predictedPrice">₹0.00</div>
                                        <small id="priceChange" class="text-muted"></small>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-4 text-center">
                                    <h6 class="text-muted">Recommendation</h6>
                                    <span class="badge fs-6" id="recommendationBadge">HOLD</span>
                                </div>
                                <div class="col-md-4 text-center">
                                    <h6 class="text-muted">Confidence</h6>
                                    <div class="progress mt-1" style="height: 20px;">
                                        <div class="progress-bar" id="confidenceBar" role="progressbar" style="width: 0%">0%</div>
                                    </div>
                                </div>
                                <div class="col-md-4 text-center">
                                    <button class="btn btn-outline-primary" id="calibrateBtn" onclick="calibrateModel()" style="display: none;">
                                        <i class="fas fa-cog me-2"></i>Calibrate Model
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Price Chart -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-area me-2"></i>
                                Price Movement & Prediction
                            </h5>
                            <button class="btn btn-sm btn-outline-secondary" onclick="downloadChart('predictionChart')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="predictionChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Analysis -->
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Enhanced Recommendation</h6>
                                </div>
                                <div class="card-body">
                                    <div id="enhancedRecommendation"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">AI Analysis</h6>
                                </div>
                                <div class="card-body">
                                    <div id="aiAnalysis"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sentiment Analysis -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-heart me-2"></i>
                                Sentiment Analysis
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="sentimentAnalysis"></div>
                        </div>
                    </div>
                </div>

                <!-- Technical Analysis Charts -->
                <div id="technicalChartsSection" class="card mb-4" style="display: none;">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>
                            Technical Analysis Charts
                        </h5>
                        <div class="d-flex gap-2">
                            <select class="form-select form-select-sm" id="chartTypeSelect" style="width: auto;">
                                <option value="candlestick">Candlestick</option>
                                <option value="renko">Renko</option>
                                <option value="kagi">Kagi</option>
                                <option value="point_figure">Point & Figure</option>
                                <option value="breakout">Breakout</option>
                            </select>
                            <select class="form-select form-select-sm" id="chartPeriodSelect" style="width: auto;">
                                <option value="1mo">1 Month</option>
                                <option value="3mo" selected>3 Months</option>
                                <option value="6mo">6 Months</option>
                                <option value="1y">1 Year</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="technical-chart-container">
                            <div class="chart-type-indicator" id="chartTypeIndicator">Candlestick</div>
                            <div class="chart-controls">
                                <button class="chart-control-btn" onclick="resetChartZoom()" title="Reset Zoom">
                                    <i class="fas fa-home"></i>
                                </button>
                                <button class="chart-control-btn" onclick="zoomIn()" title="Zoom In">
                                    <i class="fas fa-search-plus"></i>
                                </button>
                                <button class="chart-control-btn" onclick="zoomOut()" title="Zoom Out">
                                    <i class="fas fa-search-minus"></i>
                                </button>
                            </div>
                            <canvas id="technicalChart"></canvas>
                        </div>
                        <div class="row mt-3" id="chartPatternAnalysis" style="display: none;">
                            <div class="col-md-6">
                                <h6>Technical Indicators</h6>
                                <div id="technicalIndicators">
                                    <div class="loading-spinner">
                                        <div class="spinner-border spinner-border-sm" role="status"></div>
                                        <span class="ms-2">Loading indicators...</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Chart Patterns</h6>
                                <div id="candlestickPatterns">
                                    <div class="loading-spinner">
                                        <div class="spinner-border spinner-border-sm" role="status"></div>
                                        <span class="ms-2">Analyzing patterns...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Top Performing Stocks -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-star me-2"></i>
                            Top Performing Stocks
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Stock Controls -->
                        <div class="stock-controls">
                            <div class="w-100 mb-2">
                                <label class="form-label text-muted small">Category:</label>
                                <div class="d-grid gap-1 gap-md-2 d-md-flex">
                                    <button class="btn btn-outline-primary btn-sm volatility-btn active" data-category="safe">Safe</button>
                                    <button class="btn btn-outline-primary btn-sm volatility-btn" data-category="volatile">Volatile</button>
                                    <button class="btn btn-outline-primary btn-sm volatility-btn" data-category="highly_volatile">High Risk</button>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-6 col-md-6">
                                    <label for="stockCount" class="form-label text-muted small">Number of Stocks:</label>
                                    <select class="form-select form-select-sm" id="stockCount">
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5" selected>5</option>
                                        <option value="6">6</option>
                                        <option value="7">7</option>
                                        <option value="8">8</option>
                                        <option value="9">9</option>
                                        <option value="10">10</option>
                                    </select>
                                </div>
                                <div class="col-6 col-md-6">
                                    <label for="timePeriod" class="form-label text-muted small">Time Period (Days):</label>
                                    <input type="number" class="form-control form-control-sm" id="timePeriod" 
                                           min="1" max="30" value="5" placeholder="1-30">
                                </div>
                            </div>
                        </div>
                        
                        <div id="topStocksList">
                            <div class="loading-spinner">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <span class="ms-2">Loading stocks...</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Market Summary -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>
                            Market Summary
                        </h5>
                        <small class="market-status text-muted"></small>
                    </div>
                    <div class="card-body">
                        <div class="row" id="marketIndices">
                            <div class="loading-spinner text-center">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <span class="ms-2">Loading market indices...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Paper Trading -->
                <div class="card mt-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-money-check-alt me-2"></i>
                            Paper Trading
                        </h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshTrading()">
                            <i class="fas fa-rotate"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-6">
                                <small class="text-muted">Cash</small>
                                <div class="fw-bold" id="acctCash">₹0.00</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Equity</small>
                                <div class="fw-bold" id="acctEquity">₹0.00</div>
                            </div>
                        </div>

                        <form id="orderForm" class="row g-2 mb-3" onsubmit="placeOrder(event)">
                            <div class="col-4">
                                <input type="text" class="form-control form-control-sm" id="orderSymbol" placeholder="Symbol">
                            </div>
                            <div class="col-3">
                                <input type="number" class="form-control form-control-sm" id="orderQty" min="1" placeholder="Qty">
                            </div>
                            <div class="col-3">
                                <select id="orderSide" class="form-select form-select-sm">
                                    <option value="BUY">BUY</option>
                                    <option value="SELL">SELL</option>
                                </select>
                            </div>
                            <div class="col-2 d-grid">
                                <button class="btn btn-sm btn-primary" type="submit">Go</button>
                            </div>
                        </form>

                        <div class="mb-3">
                            <h6 class="mb-2">Positions</h6>
                            <div id="positionsList" class="small text-muted">No positions</div>
                        </div>

                        <div class="mb-3">
                            <h6 class="mb-2">Orders</h6>
                            <div id="ordersList" class="small text-muted">No orders</div>
                        </div>

                        <div>
                            <h6 class="mb-2">Alerts</h6>
                            <form id="alertForm" class="row g-2 mb-2" onsubmit="addAlert(event)">
                                <div class="col-4">
                                    <input type="text" class="form-control form-control-sm" id="alertSymbol" placeholder="Symbol">
                                </div>
                                <div class="col-6">
                                    <input type="text" class="form-control form-control-sm" id="alertCondition" placeholder="e.g., price>2500">
                                </div>
                                <div class="col-2 d-grid">
                                    <button class="btn btn-sm btn-outline-primary" type="submit">Add</button>
                                </div>
                            </form>
                            <div id="alertsList" class="small text-muted">No alerts</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Chat Assistant -->
    <div class="ai-chat-container">
        <div class="ai-chat-panel" id="aiChatPanel">
            <div class="ai-chat-header">
                <div class="d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-robot me-2"></i>AI Investment Assistant</span>
                    <div class="d-flex align-items-center gap-2">
                        <select id="aiLangSelect" class="form-select form-select-sm" style="width: auto;">
                            <option value="auto" selected>Auto</option>
                            <option value="en">English</option>
                            <option value="te">తెలుగు</option>
                            <option value="ta">தமிழ்</option>
                            <option value="hi">हिंदी</option>
                            <option value="es">Español</option>
                            <option value="fr">Français</option>
                        </select>
                        <button id="aiSpeakToggle" class="btn btn-sm btn-light" title="Toggle voice reply" type="button">
                            <i class="fas fa-volume-up"></i>
                        </button>
                        <button id="aiMicBtn" class="btn btn-sm btn-light" title="Voice input" type="button">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <button class="btn btn-sm text-white" onclick="toggleAIChat()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="ai-chat-messages" id="aiChatMessages">
                <div class="message ai">
                    <strong>AI Assistant:</strong> Hello! I can help you understand stock predictions, explain technical indicators, and provide investment guidance. I search the web for the latest information to give you accurate answers. Ask me anything!
                </div>
            </div>
            <div class="ai-chat-input">
                <form id="aiChatForm">
                    <div class="input-group">
                        <input type="text" class="form-control" id="aiChatInput" placeholder="Ask me about stocks...">
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <button class="ai-chat-toggle" onclick="toggleAIChat()" title="AI Assistant">
            <i class="fas fa-comments"></i>
        </button>
    </div>

    <!-- Notification Toast -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 9999;">
        <div id="notificationToast" class="toast" role="alert">
            <div class="toast-header">
                <strong class="me-auto" id="toastTitle">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                <!-- Toast message will be populated here -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom/dist/chartjs-plugin-zoom.min.js"></script>
    
    <script>
        let currentStockSymbol = '';
        let predictionChart;
        let technicalChart;
        let currentChartType = 'candlestick';

        // Theme Management
        function toggleTheme() {
            const html = document.documentElement;
            const themeIcon = document.getElementById('themeIcon');
            
            if (html.getAttribute('data-theme') === 'light') {
                html.setAttribute('data-theme', 'dark');
                themeIcon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'dark');
            } else {
                html.setAttribute('data-theme', 'light');
                themeIcon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'light');
            }
            
            // Update charts for theme change
            updateChartsForTheme();
        }

        // Load saved theme
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const themeIcon = document.getElementById('themeIcon');
            
            document.documentElement.setAttribute('data-theme', savedTheme);
            themeIcon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            
            // Load top stocks
            loadTopStocks();
            
            // Setup event listeners
            setupEventListeners();

            // Load market indices initially and on interval
            updateMarketIndices();
            setInterval(updateMarketIndices, 30000);

            // Load paper trading data
            refreshTrading();
        });

        function setupEventListeners() {
            // Prediction form
            document.getElementById('predictionForm').addEventListener('submit', handlePredictionSubmit);
            
            // Volatility buttons
            document.querySelectorAll('.volatility-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.volatility-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    loadTopStocks();
                });
            });
            
            // Stock controls
            document.getElementById('stockCount').addEventListener('change', loadTopStocks);
            document.getElementById('timePeriod').addEventListener('change', loadTopStocks);
            
            // Chart type selector
            document.getElementById('chartTypeSelect').addEventListener('change', function() {
                updateTechnicalChart(this.value);
            });
            
            document.getElementById('chartPeriodSelect').addEventListener('change', function() {
                updateTechnicalChart(document.getElementById('chartTypeSelect').value);
            });
        }

        // Prediction Form Handler
        async function handlePredictionSubmit(event) {
            if (event) event.preventDefault();
            
            const stockInput = document.getElementById('stockInput').value.trim();
            const days = document.getElementById('predictionDays').value;
            
            if (!stockInput) {
                showToast('Error', 'Please enter a stock symbol', 'error');
                return;
            }
            
            showPredictionLoading(true);
            
            try {
                // Search for stock first
                const searchResponse = await fetch('/api/search-stock', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ input: stockInput })
                });
                
                const searchData = await searchResponse.json();
                let symbol = searchData.found ? searchData.symbol : stockInput.toUpperCase();
                
                // Get prediction
                const response = await fetch('/api/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        symbol: symbol,
                        days_ahead: parseInt(days)
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                currentStockSymbol = data.symbol;
                displayPredictionResults(data);
                
                // Load technical charts
                updateTechnicalChart('candlestick');
                
                showPredictionLoading(false);
                
            } catch (error) {
                console.error('Prediction error:', error);
                showPredictionLoading(false);
                showToast('Error', error.message, 'error');
                showPredictionInitial();
            }
        }

        function showPredictionLoading(show) {
            const elements = {
                loading: document.getElementById('predictionLoading'),
                initial: document.getElementById('predictionInitial'),
                results: document.getElementById('predictionResults')
            };
            
            if (show) {
                elements.loading.style.display = 'block';
                elements.initial.style.display = 'none';
                elements.results.classList.add('d-none');
            } else {
                elements.loading.style.display = 'none';
            }
        }

        function showPredictionInitial() {
            const elements = {
                loading: document.getElementById('predictionLoading'),
                initial: document.getElementById('predictionInitial'),
                results: document.getElementById('predictionResults')
            };
            
            elements.loading.style.display = 'none';
            elements.initial.style.display = 'block';
            elements.results.classList.add('d-none');
        }

        function displayPredictionResults(data) {
            // Hide loading and initial states
            document.getElementById('predictionLoading').style.display = 'none';
            document.getElementById('predictionInitial').style.display = 'none';
            document.getElementById('predictionResults').classList.remove('d-none');
            
            // Update basic info
            document.getElementById('stockName').textContent = `${data.symbol} - ${data.name}`;
            document.getElementById('currentPrice').textContent = `₹${data.current_price}`;
            document.getElementById('predictedPrice').textContent = `₹${data.predicted_price}`;
            document.getElementById('predictionPeriodLabel').textContent = `(${data.days_ahead}-day)`;
            
            // Update price change
            const priceChange = data.predicted_price - data.current_price;
            const priceChangeElement = document.getElementById('priceChange');
            const changeClass = priceChange >= 0 ? 'text-success' : 'text-danger';
            const changeIcon = priceChange >= 0 ? 'up' : 'down';
            
            priceChangeElement.textContent = `${priceChange >= 0 ? '+' : ''}₹${Math.abs(priceChange).toFixed(2)} (${data.price_change_pct >= 0 ? '+' : ''}${data.price_change_pct}%)`;
            priceChangeElement.className = `text-muted ${changeClass}`;
            
            // Update confidence
            const confidenceBar = document.getElementById('confidenceBar');
            confidenceBar.style.width = `${data.confidence}%`;
            confidenceBar.textContent = `${data.confidence}%`;
            
            // Update recommendation badge
            const recommendationBadge = document.getElementById('recommendationBadge');
            recommendationBadge.textContent = data.recommendation;
            recommendationBadge.className = `badge fs-6 ${getRecommendationClass(data.recommendation)}`;
            
            // Show calibrate button
            document.getElementById('calibrateBtn').style.display = 'inline-block';
            
            // Update prediction chart
            updatePredictionChart(data);
            
            // Update enhanced recommendation
            updateEnhancedRecommendation(data.enhanced_recommendation);
            
            // Update AI analysis
            updateAIAnalysis(data.ai_analysis);
            
            // Update sentiment analysis
            updateSentimentAnalysis(data.sentiment_analysis);
        }

        function updatePredictionChart(data) {
            const ctx = document.getElementById('predictionChart');
            if (!ctx) return;
            
            if (predictionChart) {
                predictionChart.destroy();
            }
            
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? '#ffffff' : '#212529';
            const gridColor = isDark ? '#404040' : '#dee2e6';
            
            // Combine historical and prediction data
            const allData = [...data.historical_data, ...data.prediction_data.slice(1)];
            const labels = allData.map(item => item.date);
            const prices = allData.map(item => item.price);
            
            // Split data for different styling
            const historicalPrices = data.historical_data.map(item => item.price);
            const predictionPrices = new Array(historicalPrices.length - 1).fill(null);
            predictionPrices.push(data.current_price);
            predictionPrices.push(...data.prediction_data.slice(1).map(item => item.price));
            
            predictionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Historical Price',
                            data: [...historicalPrices, ...new Array(data.prediction_data.length - 1).fill(null)],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Predicted Price',
                            data: predictionPrices,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: textColor }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        },
                        y: {
                            ticks: { 
                                color: textColor,
                                callback: function(value) {
                                    return '₹' + value.toFixed(2);
                                }
                            },
                            grid: { color: gridColor }
                        }
                    }
                }
            });
        }

        async function updateTechnicalChart(chartType) {
            if (!currentStockSymbol) return;
            
            try {
                const period = document.getElementById('chartPeriodSelect').value;
                const response = await fetch(`/api/technical-chart/${currentStockSymbol}?type=${chartType}&period=${period}`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    displayTechnicalChart(data, chartType);
                    displayChartPatterns(data.patterns);
                    displayTechnicalIndicators(data.indicators);
                    document.getElementById('technicalChartsSection').style.display = 'block';
                    document.getElementById('chartPatternAnalysis').style.display = 'block';
                    
                    // Update chart type indicator
                    document.getElementById('chartTypeIndicator').textContent = getChartTypeDisplayName(chartType);
                } else {
                    console.error('Failed to load technical chart:', data.error);
                }
                
            } catch (error) {
                console.error('Technical chart error:', error);
            }
        }

        function displayTechnicalChart(data, chartType) {
            const container = document.getElementById('technicalChart');
            if (!container) return;
            
            if (technicalChart) {
                technicalChart.destroy();
            }
            
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? '#ffffff' : '#212529';
            const gridColor = isDark ? '#404040' : '#dee2e6';
            
            const chartData = data.data;
            const labels = chartData.map(d => d.date);
            
            let datasets = [];
            
            // Create different chart types
            if (chartType === 'candlestick') {
                datasets = createCandlestickDatasets(chartData);
            } else {
                // For other chart types, use simple line chart
                datasets = [{
                    label: `${data.symbol} - ${chartType.charAt(0).toUpperCase() + chartType.slice(1)}`,
                    data: chartData.map(item => item.close || item.price || 0),
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1
                }];
            }
            
            technicalChart = new Chart(container, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { color: textColor }
                        },
                        zoom: {
                            zoom: {
                                wheel: { enabled: true },
                                pinch: { enabled: true },
                                mode: 'x'
                            },
                            pan: {
                                enabled: true,
                                mode: 'x'
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Date',
                                color: textColor
                            },
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Price (₹)',
                                color: textColor
                            },
                            ticks: { 
                                color: textColor,
                                callback: function(value) {
                                    return '₹' + value.toFixed(2);
                                }
                            },
                            grid: { color: gridColor }
                        }
                    }
                }
            });
        }

        function createCandlestickDatasets(chartData) {
            return [{
                label: 'High',
                data: chartData.map(d => d.high),
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.1,
                pointRadius: 0,
                fill: '+1'
            }, {
                label: 'Low',
                data: chartData.map(d => d.low),
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.1,
                pointRadius: 0,
                fill: false
            }, {
                label: 'Close',
                data: chartData.map(d => d.close),
                borderColor: '#007bff',
                backgroundColor: 'transparent',
                tension: 0.1,
                pointRadius: 1,
                borderWidth: 2,
                fill: false
            }];
        }

        function getChartTypeDisplayName(type) {
            const displayNames = {
                'candlestick': 'Candlestick',
                'renko': 'Renko',
                'kagi': 'Kagi',
                'point_figure': 'Point & Figure',
                'breakout': 'Breakout'
            };
            return displayNames[type] || type;
        }

        function displayTechnicalIndicators(indicators) {
            const container = document.getElementById('technicalIndicators');
            
            const indicatorsList = [
                { 
                    key: 'rsi', 
                    label: 'RSI (14)', 
                    tooltip: 'Relative Strength Index - measures overbought/oversold conditions. Values above 70 suggest overbought, below 30 suggest oversold.' 
                },
                { 
                    key: 'macd', 
                    label: 'MACD', 
                    tooltip: 'Moving Average Convergence Divergence - trend-following momentum indicator. Positive values suggest bullish momentum.' 
                },
                { 
                    key: 'sma_20', 
                    label: 'SMA (20)', 
                    tooltip: 'Simple Moving Average (20 days) - average price over last 20 days. Price above SMA suggests uptrend.' 
                },
                { 
                    key: 'bb_upper', 
                    label: 'BB Upper', 
                    tooltip: 'Bollinger Bands Upper - price touching upper band may indicate overbought condition.' 
                },
                { 
                    key: 'bb_lower', 
                    label: 'BB Lower', 
                    tooltip: 'Bollinger Bands Lower - price touching lower band may indicate oversold condition.' 
                }
            ];
            
            container.innerHTML = indicatorsList.map(indicator => {
                const value = indicators[indicator.key];
                const displayValue = value !== null && value !== undefined ? 
                    (typeof value === 'number' ? value.toFixed(2) : value) : 'N/A';
                
                return `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>${indicator.label}
                            <i class="fas fa-info-circle info-tooltip ms-1">
                                <div class="tooltip-content">${indicator.tooltip}</div>
                            </i>
                        </span>
                        <strong>₹${displayValue}</strong>
                    </div>
                `;
            }).join('');
        }

        function displayChartPatterns(patterns) {
            const container = document.getElementById('candlestickPatterns');
            if (!container) return;
            
            if (patterns && patterns.detected_patterns && patterns.detected_patterns.length > 0) {
                container.innerHTML = patterns.detected_patterns.map(pattern => 
                    `<div class="mb-2">
                        <span class="badge bg-primary">${pattern}</span>
                    </div>`
                ).join('');
            } else {
                container.innerHTML = '<small class="text-muted">No significant patterns detected</small>';
            }
        }

        async function loadTopStocks() {
            try {
                const container = document.getElementById('topStocksList');
                container.innerHTML = `
                    <div class="loading-spinner">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        <span class="ms-2">Loading stocks...</span>
                    </div>
                `;
                
                const category = document.querySelector('.volatility-btn.active').dataset.category;
                const count = document.getElementById('stockCount').value;
                const timePeriod = document.getElementById('timePeriod').value;
                
                const response = await fetch(`/api/top-stocks?category=${category}&count=${count}&time_period=${timePeriod}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                displayTopStocks(data.stocks, data.time_period);
                
            } catch (error) {
                document.getElementById('topStocksList').innerHTML = `
                    <div class="text-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span class="ms-2">Failed to load stocks</span>
                    </div>
                `;
                console.error('Error loading top stocks:', error);
            }
        }

        function displayTopStocks(stocks, timePeriod) {
            const container = document.getElementById('topStocksList');
            
            const stocksHTML = stocks.map(stock => `
                <div class="stock-item">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <div class="fw-bold">${stock.symbol}</div>
                            <small class="text-muted">${stock.name}</small>
                        </div>
                        <button class="quick-predict-btn" onclick="quickPredict('${stock.symbol}')">
                            <i class="fas fa-bolt"></i> Quick Predict
                        </button>
                    </div>
                    
                    <div class="row text-center">
                        <div class="col-6">
                            <small class="text-muted">Current Price</small>
                            <div class="fw-bold">₹${stock.current_price}</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Predicted Price</small>
                            <div class="fw-bold text-${stock.predicted_change >= 0 ? 'success' : 'danger'}">
                                ₹${stock.predicted_price}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row text-center mt-2">
                        <div class="col-6">
                            <small class="text-muted">${timePeriod}D Historical Change</small>
                            <div class="small ${stock.price_change >= 0 ? 'text-success' : 'text-danger'}">
                                ${stock.price_change >= 0 ? '+' : ''}${stock.price_change.toFixed(2)}%
                            </div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Predicted Change</small>
                            <div class="small ${stock.predicted_change >= 0 ? 'text-success' : 'text-danger'}">
                                ${stock.predicted_change >= 0 ? '+' : ''}${stock.predicted_change.toFixed(2)}%
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-2">
                        <small class="text-muted">${stock.sector}</small>
                        <small class="text-primary">${stock.prediction_confidence}% confidence</small>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = stocksHTML;
        }

        // ===== Paper Trading UI =====
        async function refreshTrading() {
            await Promise.all([
                loadAccount(),
                loadPositions(),
                loadOrders(),
                loadAlerts()
            ]);
        }

        async function loadAccount() {
            try {
                const res = await fetch('/api/trading/account');
                if (!res.ok) return;
                const data = await res.json();
                document.getElementById('acctCash').textContent = `₹${Number(data.cash || 0).toFixed(2)}`;
                document.getElementById('acctEquity').textContent = `₹${Number(data.equity || 0).toFixed(2)}`;
            } catch (_) {}
        }

        async function loadPositions() {
            try {
                const res = await fetch('/api/trading/positions');
                const container = document.getElementById('positionsList');
                if (!res.ok) { container.textContent = 'Failed to load'; return; }
                const data = await res.json();
                if (!data.positions || data.positions.length === 0) { container.textContent = 'No positions'; return; }
                container.innerHTML = data.positions.map(p => `
                    <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-1">
                        <div>
                            <div class="fw-bold">${p.symbol}</div>
                            <div class="small text-muted">Qty: ${p.quantity} @ ₹${p.avg_price.toFixed(2)}</div>
                        </div>
                        <div class="text-end">
                            <div class="small">Last: ₹${p.last_price.toFixed(2)}</div>
                            <div class="small ${p.unrealized_pl >= 0 ? 'text-success' : 'text-danger'}">PnL: ₹${p.unrealized_pl.toFixed(2)}</div>
                        </div>
                    </div>
                `).join('');
            } catch (_) {}
        }

        async function loadOrders() {
            try {
                const res = await fetch('/api/trading/orders');
                const container = document.getElementById('ordersList');
                if (!res.ok) { container.textContent = 'Failed to load'; return; }
                const data = await res.json();
                if (!data.orders || data.orders.length === 0) { container.textContent = 'No orders'; return; }
                container.innerHTML = data.orders.map(o => `
                    <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-1">
                        <div>
                            <div class="fw-bold">${o.side} ${o.symbol}</div>
                            <div class="small text-muted">Qty: ${o.quantity} • ${o.order_type} • ${o.status}</div>
                        </div>
                        <div class="text-end small">Fill: ₹${(o.avg_fill_price || 0).toFixed(2)}</div>
                    </div>
                `).join('');
            } catch (_) {}
        }

        async function placeOrder(event) {
            event.preventDefault();
            const symbol = document.getElementById('orderSymbol').value.trim();
            const quantity = parseInt(document.getElementById('orderQty').value || '0', 10);
            const side = document.getElementById('orderSide').value;
            if (!symbol || quantity <= 0) { showToast('Error', 'Enter symbol and quantity', 'error'); return; }
            try {
                const res = await fetch('/api/trading/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol, side, quantity })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Order failed');
                showToast('Success', `Order filled @ ₹${Number(data.fill_price || 0).toFixed(2)}`, 'success');
                document.getElementById('orderForm').reset();
                refreshTrading();
            } catch (e) {
                showToast('Error', e.message, 'error');
            }
        }

        async function loadAlerts() {
            try {
                const res = await fetch('/api/trading/alerts');
                const container = document.getElementById('alertsList');
                if (!res.ok) { container.textContent = 'Failed to load'; return; }
                const data = await res.json();
                if (!data.alerts || data.alerts.length === 0) { container.textContent = 'No alerts'; return; }
                container.innerHTML = data.alerts.map(a => `
                    <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-1">
                        <div>
                            <div class="fw-bold">${a.symbol}</div>
                            <div class="small text-muted">${a.condition}</div>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteAlert(${a.id})"><i class="fas fa-trash"></i></button>
                    </div>
                `).join('');
            } catch (_) {}
        }

        async function addAlert(event) {
            event.preventDefault();
            const symbol = document.getElementById('alertSymbol').value.trim();
            const condition = document.getElementById('alertCondition').value.trim();
            if (!symbol || !condition) { showToast('Error', 'Enter symbol and condition', 'error'); return; }
            try {
                const res = await fetch('/api/trading/alerts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol, condition })
                });
                if (!res.ok) { const d = await res.json(); throw new Error(d.error || 'Failed'); }
                document.getElementById('alertForm').reset();
                loadAlerts();
            } catch (e) {
                showToast('Error', e.message, 'error');
            }
        }

        async function deleteAlert(id) {
            try {
                const res = await fetch(`/api/trading/alerts?id=${id}`, { method: 'DELETE' });
                if (!res.ok) { const d = await res.json(); throw new Error(d.error || 'Failed'); }
                loadAlerts();
            } catch (e) {
                showToast('Error', e.message, 'error');
            }
        }

        async function quickPredict(symbol) {
            try {
                document.getElementById('stockInput').value = symbol;
                await handlePredictionSubmit();
                
                setTimeout(() => {
                    document.getElementById('predictionResults').scrollIntoView({ 
                        behavior: 'smooth' 
                    });
                }, 1000);
                
            } catch (error) {
                console.error('Quick predict error:', error);
                showToast('Error', 'Error with quick prediction: ' + error.message, 'error');
            }
        }

        async function calibrateModel() {
            if (!currentStockSymbol) {
                showToast('Error', 'Please select a stock first', 'error');
                return;
            }
            
            const calibrateBtn = document.getElementById('calibrateBtn');
            const originalText = calibrateBtn.innerHTML;
            
            calibrateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Calibrating...';
            calibrateBtn.disabled = true;
            
            try {
                const days = document.getElementById('predictionDays').value;
                const response = await fetch('/api/calibrate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        symbol: currentStockSymbol, 
                        days_ahead: parseInt(days) 
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast('Success', `Calibration completed! Accuracy: ${data.accuracy_score.toFixed(2)}%`, 'success');
                    
                    // Re-run prediction with calibrated model
                    setTimeout(() => {
                        handlePredictionSubmit();
                    }, 1000);
                } else {
                    throw new Error(data.error || 'Calibration failed');
                }
                
            } catch (error) {
                console.error('Calibration error:', error);
                showToast('Error', error.message, 'error');
            } finally {
                calibrateBtn.innerHTML = originalText;
                calibrateBtn.disabled = false;
            }
        }

        // Chart Control Functions
        function resetChartZoom() {
            if (technicalChart) {
                technicalChart.resetZoom();
            }
        }

        function zoomIn() {
            if (technicalChart) {
                technicalChart.zoom(1.1);
            }
        }

        function zoomOut() {
            if (technicalChart) {
                technicalChart.zoom(0.9);
            }
        }

        // AI Chat Functions
        function toggleAIChat() {
            const panel = document.getElementById('aiChatPanel');
            if (panel.style.display === 'none' || panel.style.display === '') {
                panel.style.display = 'flex';
            } else {
                panel.style.display = 'none';
            }
        }

        // ===== AI Chat (Text, Voice, TTS) =====
        document.getElementById('aiChatForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const input = document.getElementById('aiChatInput');
            const question = input.value.trim();
            
            if (!question) return;
            
            // Add user message
            addChatMessage(question, 'user');
            input.value = '';
            
            // Show typing indicator
            const messagesContainer = document.getElementById('aiChatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ai typing';
            typingDiv.innerHTML = '<em>AI is searching and analyzing...</em>';
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            try {
                const response = await fetch('/api/ai-assistant', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ question })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Remove typing indicator
                typingDiv.remove();
                
                // Add AI response
                const aiText = data.response || 'Sorry, I could not generate a response.';
                addChatMessage(aiText, 'ai');
                if (ttsEnabled) {
                    speakText(aiText);
                }
                
                // Check for stock prediction in response and announce it
                if (aiText.includes('prediction') || aiText.includes('price target') || aiText.includes('recommendation')) {
                    announceStockPrediction(aiText);
                }
                
            } catch (error) {
                typingDiv.remove();
                addChatMessage('Sorry, I encountered an error while searching for information. Please try again.', 'ai');
                console.error('AI Chat error:', error);
            }
        });

        function addChatMessage(message, sender) {
            const messagesContainer = document.getElementById('aiChatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            if (sender === 'ai') {
                // Convert markdown-like formatting to HTML
                const formattedMessage = message
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/\n/g, '<br>');
                messageDiv.innerHTML = formattedMessage;
            } else {
                messageDiv.textContent = message;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // --- Enhanced Voice input via Web Speech API ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let recognizing = false;
        let isContinuousMode = false;
        let voiceActivityTimeout;
        const micBtn = document.getElementById('aiMicBtn');
        const langSelect = document.getElementById('aiLangSelect');
        const speakToggle = document.getElementById('aiSpeakToggle');
        let ttsEnabled = false;
        let currentUtterance = null;

        // Voice settings
        const voiceSettings = {
            continuous: false,
            interimResults: true,
            maxAlternatives: 3,
            confidence: 0.7,
            timeout: 5000,
            volume: 1.0,
            rate: 1.0,
            pitch: 1.0
        };

        // Voice command shortcuts
        const voiceCommands = {
            'predict': () => document.getElementById('stockSymbol').focus(),
            'portfolio': () => window.location.href = '/portfolio',
            'news': () => window.location.href = '/news',
            'dashboard': () => window.location.href = '/',
            'help': () => showVoiceHelp(),
            'clear': () => document.getElementById('aiChatMessages').innerHTML = '',
            'stop': () => stopSpeaking()
        };

        if (micBtn) {
            micBtn.addEventListener('click', () => {
                if (!SpeechRecognition) {
                    showToast('Notice', 'Voice input not supported in this browser. Please use Chrome or Edge.', 'warning');
                    return;
                }
                
                if (!recognition) {
                    initializeSpeechRecognition();
                }

                if (!recognizing) {
                    startVoiceRecognition();
                } else {
                    stopVoiceRecognition();
                }
            });

            // Add long press for continuous mode
            let pressTimer;
            micBtn.addEventListener('mousedown', () => {
                pressTimer = setTimeout(() => {
                    if (!recognizing) {
                        isContinuousMode = true;
                        showToast('Info', 'Continuous mode activated. Say "stop listening" to end.', 'info');
                        startVoiceRecognition();
                    }
                }, 1000);
            });

            micBtn.addEventListener('mouseup', () => {
                clearTimeout(pressTimer);
            });

            micBtn.addEventListener('mouseleave', () => {
                clearTimeout(pressTimer);
            });
        }

        function initializeSpeechRecognition() {
            recognition = new SpeechRecognition();
            recognition.continuous = voiceSettings.continuous;
            recognition.interimResults = voiceSettings.interimResults;
            recognition.maxAlternatives = voiceSettings.maxAlternatives;
            
            // Set language
            const sel = langSelect ? langSelect.value : 'auto';
            recognition.lang = sel === 'auto' ? 'en-US' : mapLangToBCP47(sel);

            recognition.onstart = () => {
                recognizing = true;
                updateMicButton(true);
                showVoiceActivityIndicator(true);
                console.log('Voice recognition started');
            };

            recognition.onresult = (event) => {
                let finalTranscript = '';
                let interimTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    const confidence = event.results[i][0].confidence;
                    
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                // Show interim results
                if (interimTranscript) {
                    updateInterimTranscript(interimTranscript);
                }

                // Process final results
                if (finalTranscript) {
                    processVoiceInput(finalTranscript);
                }
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                handleVoiceError(event.error);
            };

            recognition.onend = () => {
                recognizing = false;
                updateMicButton(false);
                showVoiceActivityIndicator(false);
                clearInterimTranscript();
                
                if (isContinuousMode) {
                    // Restart recognition in continuous mode
                    setTimeout(() => {
                        if (isContinuousMode) {
                            recognition.start();
                        }
                    }, 100);
                }
            };
        }

        function startVoiceRecognition() {
            try {
                recognition.start();
                showToast('Info', 'Listening... Speak now!', 'info');
            } catch (error) {
                console.error('Error starting recognition:', error);
                showToast('Error', 'Could not start voice recognition. Please try again.', 'error');
            }
        }

        function stopVoiceRecognition() {
            recognizing = false;
            isContinuousMode = false;
            recognition.stop();
            updateMicButton(false);
            showVoiceActivityIndicator(false);
            clearInterimTranscript();
        }

        function processVoiceInput(transcript) {
            const input = document.getElementById('aiChatInput');
            const lowerTranscript = transcript.toLowerCase().trim();
            
            // Check for voice commands first
            for (const [command, action] of Object.entries(enhancedVoiceCommands)) {
                if (lowerTranscript.includes(command)) {
                    if (typeof action === 'function') {
                        action();
                    }
                    showToast('Voice Command', `Executed: ${command}`, 'success');
                    return;
                }
            }

            // Check for continuous mode stop command
            if (lowerTranscript.includes('stop listening') || lowerTranscript.includes('stop voice')) {
                stopVoiceRecognition();
                showToast('Voice', 'Voice recognition stopped', 'info');
                return;
            }

            // Regular chat input
            input.value = transcript;
            
            // Auto-submit for non-continuous mode
            if (!isContinuousMode) {
                document.getElementById('aiChatForm').dispatchEvent(new Event('submit'));
            }
        }

        function updateMicButton(isActive) {
            if (isActive) {
                micBtn.classList.add('btn-primary');
                micBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                micBtn.title = 'Click to stop listening';
            } else {
                micBtn.classList.remove('btn-primary');
                micBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                micBtn.title = 'Click to start voice input (hold for continuous mode)';
            }
        }

        function showVoiceActivityIndicator(show) {
            let indicator = document.getElementById('voiceActivityIndicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'voiceActivityIndicator';
                indicator.className = 'voice-activity-indicator';
                indicator.innerHTML = '<div class="pulse-ring"></div><div class="pulse-ring"></div><div class="pulse-ring"></div>';
                document.body.appendChild(indicator);
            }
            
            indicator.style.display = show ? 'block' : 'none';
        }

        function updateInterimTranscript(text) {
            let interimDiv = document.getElementById('interimTranscript');
            if (!interimDiv) {
                interimDiv = document.createElement('div');
                interimDiv.id = 'interimTranscript';
                interimDiv.className = 'interim-transcript';
                document.getElementById('aiChatMessages').appendChild(interimDiv);
            }
            interimDiv.textContent = text;
            interimDiv.style.opacity = '0.6';
        }

        function clearInterimTranscript() {
            const interimDiv = document.getElementById('interimTranscript');
            if (interimDiv) {
                interimDiv.remove();
            }
        }

        function handleVoiceError(error) {
            recognizing = false;
            updateMicButton(false);
            showVoiceActivityIndicator(false);
            clearInterimTranscript();
            
            let errorMessage = 'Voice recognition error occurred.';
            switch (error) {
                case 'no-speech':
                    errorMessage = 'No speech detected. Please try again.';
                    break;
                case 'audio-capture':
                    errorMessage = 'Microphone not accessible. Please check permissions.';
                    break;
                case 'not-allowed':
                    errorMessage = 'Microphone permission denied. Please allow microphone access.';
                    break;
                case 'network':
                    errorMessage = 'Network error. Please check your connection.';
                    break;
                case 'aborted':
                    errorMessage = 'Voice recognition was aborted.';
                    break;
            }
            
            showToast('Voice Error', errorMessage, 'error');
        }

        // --- Enhanced Text-to-speech ---
        let voices = [];
        let currentVoice = null;
        let ttsQueue = [];
        let isSpeaking = false;

        function loadVoices() {
            voices = window.speechSynthesis ? window.speechSynthesis.getVoices() : [];
            console.log('Loaded voices:', voices.length);
            
            // Set default voice preferences
            if (voices.length > 0) {
                currentVoice = pickBestVoice();
            }
        }

        if ('speechSynthesis' in window) {
            loadVoices();
            window.speechSynthesis.onvoiceschanged = loadVoices;
        }

        if (speakToggle) {
            speakToggle.addEventListener('click', () => {
                ttsEnabled = !ttsEnabled;
                speakToggle.classList.toggle('btn-primary', ttsEnabled);
                speakToggle.title = ttsEnabled ? 'Voice replies enabled' : 'Voice replies disabled';
                
                if (ttsEnabled) {
                    showToast('Voice', 'Voice replies enabled', 'success');
                } else {
                    stopSpeaking();
                    showToast('Voice', 'Voice replies disabled', 'info');
                }
            });
        }

        function speakText(text, options = {}) {
            if (!ttsEnabled || !text) return;
            
            // Clean text for better speech
            const cleanText = cleanTextForSpeech(text);
            
            // Add to queue if already speaking
            if (isSpeaking && !options.interrupt) {
                ttsQueue.push({ text: cleanText, options });
                return;
            }
            
            // Stop current speech if interrupting
            if (options.interrupt) {
                stopSpeaking();
            }
            
            const utter = new SpeechSynthesisUtterance(cleanText);
            currentUtterance = utter;
            
            // Voice settings
            const sel = langSelect ? langSelect.value : 'auto';
            const langTag = sel === 'auto' ? detectLanguageTag(text) : mapLangToBCP47(sel);
            utter.lang = langTag;
            
            const voice = pickVoiceForLang(langTag);
            if (voice) {
                utter.voice = voice;
                currentVoice = voice;
            }
            
            // Audio settings
            utter.rate = options.rate || voiceSettings.rate;
            utter.pitch = options.pitch || voiceSettings.pitch;
            utter.volume = options.volume || voiceSettings.volume;
            
            // Event handlers
            utter.onstart = () => {
                isSpeaking = true;
                updateSpeakButton(true);
                console.log('Started speaking:', cleanText.substring(0, 50) + '...');
            };
            
            utter.onend = () => {
                isSpeaking = false;
                updateSpeakButton(false);
                currentUtterance = null;
                
                // Process queue
                if (ttsQueue.length > 0) {
                    const next = ttsQueue.shift();
                    setTimeout(() => speakText(next.text, next.options), 100);
                }
            };
            
            utter.onerror = (event) => {
                console.error('TTS Error:', event.error);
                isSpeaking = false;
                updateSpeakButton(false);
                currentUtterance = null;
                showToast('Voice Error', 'Speech synthesis failed', 'error');
            };
            
            window.speechSynthesis.speak(utter);
        }

        function stopSpeaking() {
            if (currentUtterance) {
                window.speechSynthesis.cancel();
                currentUtterance = null;
            }
            isSpeaking = false;
            ttsQueue = [];
            updateSpeakButton(false);
        }

        function updateSpeakButton(isActive) {
            if (speakToggle) {
                if (isActive) {
                    speakToggle.innerHTML = '<i class="fas fa-volume-mute"></i>';
                    speakToggle.title = 'Click to stop speaking';
                } else {
                    speakToggle.innerHTML = '<i class="fas fa-volume-up"></i>';
                    speakToggle.title = ttsEnabled ? 'Voice replies enabled' : 'Voice replies disabled';
                }
            }
        }

        function cleanTextForSpeech(text) {
            // Remove markdown formatting
            let clean = text
                .replace(/\*\*(.*?)\*\*/g, '$1')  // Bold
                .replace(/\*(.*?)\*/g, '$1')      // Italic
                .replace(/`(.*?)`/g, '$1')        // Code
                .replace(/#{1,6}\s*/g, '')        // Headers
                .replace(/\[(.*?)\]\(.*?\)/g, '$1') // Links
                .replace(/\n+/g, '. ')            // Line breaks
                .replace(/\s+/g, ' ')             // Multiple spaces
                .trim();
            
            // Replace common symbols with words
            clean = clean
                .replace(/&/g, ' and ')
                .replace(/%/g, ' percent ')
                .replace(/\$/g, ' dollars ')
                .replace(/₹/g, ' rupees ')
                .replace(/€/g, ' euros ')
                .replace(/£/g, ' pounds ')
                .replace(/@/g, ' at ')
                .replace(/#/g, ' number ')
                .replace(/\*/g, ' ')
                .replace(/\+/g, ' plus ')
                .replace(/-/g, ' minus ')
                .replace(/=/g, ' equals ')
                .replace(/</g, ' less than ')
                .replace(/>/g, ' greater than ');
            
            // Clean up multiple spaces and periods
            clean = clean
                .replace(/\s+/g, ' ')
                .replace(/\.+/g, '.')
                .replace(/\.\s*\./g, '.')
                .trim();
            
            return clean;
        }

        function pickBestVoice() {
            if (!voices || voices.length === 0) return null;
            
            // Prefer high-quality voices
            const preferredVoices = voices.filter(v => 
                v.name.includes('Google') || 
                v.name.includes('Microsoft') || 
                v.name.includes('Neural') ||
                v.name.includes('Enhanced')
            );
            
            if (preferredVoices.length > 0) {
                return preferredVoices[0];
            }
            
            // Fallback to first available voice
            return voices[0];
        }

        function mapLangToBCP47(code) {
            switch (code) {
                case 'en': return 'en-US';
                case 'hi': return 'hi-IN';
                case 'te': return 'te-IN';
                case 'ta': return 'ta-IN';
                case 'es': return 'es-ES';
                case 'fr': return 'fr-FR';
                default: return 'en-US';
            }
        }

        function pickVoiceForLang(langTag) {
            if (!voices || voices.length === 0) return null;
            const exact = voices.find(v => v.lang && v.lang.toLowerCase() === langTag.toLowerCase());
            if (exact) return exact;
            const base = langTag.split('-')[0];
            return voices.find(v => v.lang && v.lang.toLowerCase().startsWith(base));
        }

        function detectLanguageTag(text) {
            // Simple heuristic: default to English if mostly ASCII.
            // Users can override via language selector.
            const asciiRatio = (text.match(/[\x00-\x7F]/g) || []).length / Math.max(1, text.length);
            if (asciiRatio > 0.9) return 'en-US';
            // Fallback to English to avoid wrong voices; users can select manually.
            return 'en-US';
        }

        // Voice Settings Panel Functions
        function createVoiceSettingsPanel() {
            const panel = document.createElement('div');
            panel.id = 'voiceSettingsPanel';
            panel.className = 'voice-settings-panel';
            panel.innerHTML = `
                <div class="voice-settings-header">
                    <h6><i class="fas fa-cog me-2"></i>Voice Settings</h6>
                    <button type="button" class="btn-close" onclick="closeVoiceSettings()"></button>
                </div>
                <div class="voice-settings-content">
                    <div class="mb-3">
                        <label class="form-label">Voice</label>
                        <select id="voiceSelect" class="form-select form-select-sm">
                            <option value="auto">Auto Select</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Speech Rate: <span id="rateValue">1.0</span></label>
                        <input type="range" id="rateSlider" class="form-range" min="0.5" max="2.0" step="0.1" value="1.0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Pitch: <span id="pitchValue">1.0</span></label>
                        <input type="range" id="pitchSlider" class="form-range" min="0.5" max="2.0" step="0.1" value="1.0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Volume: <span id="volumeValue">1.0</span></label>
                        <input type="range" id="volumeSlider" class="form-range" min="0.1" max="1.0" step="0.1" value="1.0">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="continuousMode" checked>
                            <label class="form-check-label" for="continuousMode">
                                Continuous Recognition
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="interimResults" checked>
                            <label class="form-check-label" for="interimResults">
                                Show Interim Results
                            </label>
                        </div>
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-sm" onclick="testVoice()">
                            <i class="fas fa-play me-1"></i>Test Voice
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="resetVoiceSettings()">
                            <i class="fas fa-undo me-1"></i>Reset to Default
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(panel);
            populateVoiceSelect();
            setupVoiceSettingsHandlers();
        }

        function populateVoiceSelect() {
            const voiceSelect = document.getElementById('voiceSelect');
            if (!voiceSelect) return;
            
            voiceSelect.innerHTML = '<option value="auto">Auto Select</option>';
            
            voices.forEach((voice, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${voice.name} (${voice.lang})`;
                if (voice === currentVoice) {
                    option.selected = true;
                }
                voiceSelect.appendChild(option);
            });
        }

        function setupVoiceSettingsHandlers() {
            // Rate slider
            const rateSlider = document.getElementById('rateSlider');
            const rateValue = document.getElementById('rateValue');
            if (rateSlider && rateValue) {
                rateSlider.addEventListener('input', (e) => {
                    voiceSettings.rate = parseFloat(e.target.value);
                    rateValue.textContent = e.target.value;
                });
            }
            
            // Pitch slider
            const pitchSlider = document.getElementById('pitchSlider');
            const pitchValue = document.getElementById('pitchValue');
            if (pitchSlider && pitchValue) {
                pitchSlider.addEventListener('input', (e) => {
                    voiceSettings.pitch = parseFloat(e.target.value);
                    pitchValue.textContent = e.target.value;
                });
            }
            
            // Volume slider
            const volumeSlider = document.getElementById('volumeSlider');
            const volumeValue = document.getElementById('volumeValue');
            if (volumeSlider && volumeValue) {
                volumeSlider.addEventListener('input', (e) => {
                    voiceSettings.volume = parseFloat(e.target.value);
                    volumeValue.textContent = e.target.value;
                });
            }
            
            // Voice selection
            const voiceSelect = document.getElementById('voiceSelect');
            if (voiceSelect) {
                voiceSelect.addEventListener('change', (e) => {
                    if (e.target.value === 'auto') {
                        currentVoice = pickBestVoice();
                    } else {
                        currentVoice = voices[parseInt(e.target.value)];
                    }
                });
            }
        }

        function testVoice() {
            const testText = "Hello! This is a test of the voice feature. The speech rate, pitch, and volume are now being tested.";
            speakText(testText, { interrupt: true });
        }

        function resetVoiceSettings() {
            voiceSettings.rate = 1.0;
            voiceSettings.pitch = 1.0;
            voiceSettings.volume = 1.0;
            currentVoice = pickBestVoice();
            
            // Update UI
            const rateSlider = document.getElementById('rateSlider');
            const pitchSlider = document.getElementById('pitchSlider');
            const volumeSlider = document.getElementById('volumeSlider');
            const voiceSelect = document.getElementById('voiceSelect');
            
            if (rateSlider) rateSlider.value = 1.0;
            if (pitchSlider) pitchSlider.value = 1.0;
            if (volumeSlider) volumeSlider.value = 1.0;
            if (voiceSelect) voiceSelect.value = 'auto';
            
            document.getElementById('rateValue').textContent = '1.0';
            document.getElementById('pitchValue').textContent = '1.0';
            document.getElementById('volumeValue').textContent = '1.0';
            
            showToast('Voice', 'Voice settings reset to default', 'success');
        }

        function closeVoiceSettings() {
            const panel = document.getElementById('voiceSettingsPanel');
            if (panel) {
                panel.remove();
            }
        }

        // Add voice settings button to the UI
        function addVoiceSettingsButton() {
            const voiceControls = document.querySelector('.d-flex.align-items-center.gap-2');
            if (voiceControls) {
                const settingsBtn = document.createElement('button');
                settingsBtn.className = 'btn btn-sm btn-light';
                settingsBtn.title = 'Voice Settings';
                settingsBtn.innerHTML = '<i class="fas fa-cog"></i>';
                settingsBtn.onclick = () => {
                    createVoiceSettingsPanel();
                };
                voiceControls.appendChild(settingsBtn);
            }
        }

        // Initialize voice settings button when page loads
        setTimeout(addVoiceSettingsButton, 1000);

        // Voice announcement functions
        function announceStockPrediction(text) {
            if (!ttsEnabled) return;
            
            // Extract key information from prediction text
            const prediction = extractPredictionInfo(text);
            if (prediction) {
                const announcement = formatPredictionAnnouncement(prediction);
                speakText(announcement, { interrupt: true });
            }
        }

        function extractPredictionInfo(text) {
            const prediction = {
                symbol: null,
                currentPrice: null,
                predictedPrice: null,
                recommendation: null,
                confidence: null
            };

            // Extract stock symbol
            const symbolMatch = text.match(/([A-Z]{2,5})\s*(?:stock|shares?|equity)/i);
            if (symbolMatch) {
                prediction.symbol = symbolMatch[1];
            }

            // Extract current price
            const currentPriceMatch = text.match(/current\s*price[:\s]*₹?(\d+(?:\.\d{2})?)/i);
            if (currentPriceMatch) {
                prediction.currentPrice = parseFloat(currentPriceMatch[1]);
            }

            // Extract predicted price
            const predictedPriceMatch = text.match(/predicted?\s*price[:\s]*₹?(\d+(?:\.\d{2})?)/i);
            if (predictedPriceMatch) {
                prediction.predictedPrice = parseFloat(predictedPriceMatch[1]);
            }

            // Extract recommendation
            const recommendationMatch = text.match(/(buy|sell|hold|strong buy|strong sell)/i);
            if (recommendationMatch) {
                prediction.recommendation = recommendationMatch[1].toLowerCase();
            }

            // Extract confidence
            const confidenceMatch = text.match(/(\d+)%?\s*confidence/i);
            if (confidenceMatch) {
                prediction.confidence = parseInt(confidenceMatch[1]);
            }

            return prediction.symbol || prediction.currentPrice || prediction.predictedPrice ? prediction : null;
        }

        function formatPredictionAnnouncement(prediction) {
            let announcement = "Stock prediction update. ";
            
            if (prediction.symbol) {
                announcement += `For ${prediction.symbol}. `;
            }
            
            if (prediction.currentPrice && prediction.predictedPrice) {
                const change = prediction.predictedPrice - prediction.currentPrice;
                const changePercent = ((change / prediction.currentPrice) * 100).toFixed(1);
                announcement += `Current price is ₹${prediction.currentPrice}. `;
                announcement += `Predicted price is ₹${prediction.predictedPrice}. `;
                announcement += `Expected change of ${change > 0 ? 'plus' : 'minus'} ${Math.abs(changePercent)} percent. `;
            }
            
            if (prediction.recommendation) {
                announcement += `Recommendation is ${prediction.recommendation}. `;
            }
            
            if (prediction.confidence) {
                announcement += `Confidence level is ${prediction.confidence} percent. `;
            }
            
            announcement += "Please review the full analysis before making investment decisions.";
            
            return announcement;
        }

        // Enhanced voice commands for stock analysis
        const enhancedVoiceCommands = {
            ...voiceCommands,
            'analyze': (symbol) => {
                if (symbol) {
                    document.getElementById('stockSymbol').value = symbol;
                    document.getElementById('predictBtn').click();
                } else {
                    document.getElementById('stockSymbol').focus();
                }
            },
            'what is the price': () => {
                const symbol = document.getElementById('stockSymbol').value;
                if (symbol) {
                    getStockPrice(symbol);
                } else {
                    speakText("Please enter a stock symbol first.");
                }
            },
            'show chart': () => {
                const symbol = document.getElementById('stockSymbol').value;
                if (symbol) {
                    loadChart(symbol);
                } else {
                    speakText("Please enter a stock symbol first.");
                }
            },
            'market status': () => {
                announceMarketStatus();
            },
            'top gainers': () => {
                loadTopStocks();
                speakText("Loading top performing stocks.");
            },
            'news': () => {
                window.location.href = '/news';
                speakText("Opening market news.");
            }
        };

        function announceMarketStatus() {
            const now = new Date();
            const hour = now.getHours();
            const day = now.getDay();
            
            let status = "Market status update. ";
            
            if (day === 0 || day === 6) {
                status += "Markets are closed for the weekend. ";
            } else if (hour >= 9 && hour < 16) {
                status += "Markets are currently open. ";
            } else if (hour >= 16) {
                status += "Markets are closed for the day. ";
            } else {
                status += "Markets will open at 9 AM. ";
            }
            
            status += `Current time is ${now.toLocaleTimeString()}.`;
            
            speakText(status);
        }

        // Voice alerts for price movements
        function setupVoiceAlerts() {
            // Monitor for significant price changes
            setInterval(() => {
                if (ttsEnabled && document.getElementById('currentPrice')) {
                    const currentPrice = parseFloat(document.getElementById('currentPrice').textContent);
                    const previousPrice = parseFloat(document.getElementById('currentPrice').dataset.previousPrice || currentPrice);
                    
                    if (previousPrice && currentPrice !== previousPrice) {
                        const change = currentPrice - previousPrice;
                        const changePercent = ((change / previousPrice) * 100).toFixed(2);
                        
                        if (Math.abs(changePercent) > 2) { // Alert for >2% change
                            const symbol = document.getElementById('stockSymbol').value;
                            const direction = change > 0 ? 'increased' : 'decreased';
                            const announcement = `${symbol} price has ${direction} by ${Math.abs(changePercent)} percent to ₹${currentPrice}.`;
                            speakText(announcement, { interrupt: false });
                        }
                        
                        document.getElementById('currentPrice').dataset.previousPrice = currentPrice;
                    }
                }
            }, 5000); // Check every 5 seconds
        }

        // Initialize voice alerts
        setTimeout(setupVoiceAlerts, 2000);

        // Voice help system
        function showVoiceHelp() {
            const helpText = `
## 🎤 Voice Commands Available

**Navigation Commands:**
• "predict" - Focus on stock symbol input
• "portfolio" - Go to portfolio page
• "news" - Go to news page
• "dashboard" - Go to main dashboard

**Stock Analysis Commands:**
• "analyze [symbol]" - Analyze specific stock
• "what is the price" - Get current stock price
• "show chart" - Display stock chart
• "market status" - Check market hours
• "top gainers" - Show top performing stocks

**Voice Control Commands:**
• "help" - Show this help message
• "clear" - Clear chat messages
• "stop" - Stop current speech
• "stop listening" - End voice recognition

**Voice Features:**
• Click microphone for single recognition
• Hold microphone for continuous mode
• Voice replies can be enabled/disabled
• Customizable speech rate, pitch, and volume
• Automatic stock prediction announcements
• Price movement alerts

**Tips:**
• Speak clearly and at normal pace
• Use specific stock symbols (e.g., "TCS", "RELIANCE")
• Voice commands work in any language you select
• Long press microphone for hands-free operation
            `;
            
            addChatMessage(helpText, 'ai');
            
            if (ttsEnabled) {
                const spokenHelp = "Voice commands available: predict, portfolio, news, dashboard, analyze, what is the price, show chart, market status, top gainers, help, clear, stop, and stop listening. Click the microphone to start voice input, or hold it for continuous mode.";
                speakText(spokenHelp);
            }
        }

        // Voice tutorial for new users
        function showVoiceTutorial() {
            if (!localStorage.getItem('voiceTutorialShown')) {
                setTimeout(() => {
                    const tutorialText = `
## 🎤 Welcome to Voice Features!

I've enhanced the chatbot with advanced voice capabilities:

**Try saying:**
• "Hello" - Start a conversation
• "Help" - See all voice commands
• "Predict TCS" - Get stock analysis
• "Market status" - Check if markets are open

**Voice Controls:**
• 🎤 Click microphone to start voice input
• 🔄 Hold microphone for continuous listening
• 🔊 Click speaker to enable/disable voice replies
• ⚙️ Click settings to customize voice options

**Features:**
• Real-time speech recognition
• Natural language processing
• Voice announcements for predictions
• Price movement alerts
• Multi-language support

*This tutorial won't show again. You can always say "help" for voice commands.*
                    `;
                    
                    addChatMessage(tutorialText, 'ai');
                    
                    if (ttsEnabled) {
                        speakText("Welcome to the enhanced voice features! Try saying 'help' to see all available voice commands, or 'predict TCS' to get a stock analysis.");
                    }
                    
                    localStorage.setItem('voiceTutorialShown', 'true');
                }, 3000);
            }
        }

        // Show tutorial for new users
        setTimeout(showVoiceTutorial, 1000);

        // UI Helper Functions
        function updateEnhancedRecommendation(recommendation) {
            const container = document.getElementById('enhancedRecommendation');
            if (!container || !recommendation) return;
            
            container.innerHTML = `
                <div class="mb-3">
                    <span class="badge ${getRecommendationClass(recommendation.action)} mb-2">
                        ${recommendation.action}
                    </span>
                    <div class="small"><strong>Strength:</strong> ${recommendation.strength}</div>
                </div>
                <div class="mb-3">
                    <strong>Analysis:</strong>
                    <ul class="mt-2 mb-0">
                        ${recommendation.reasoning.map(reason => `<li><small>${reason}</small></li>`).join('')}
                    </ul>
                </div>
                ${recommendation.risk_level ? `
                    <div class="small">
                        <strong>Risk Level:</strong> 
                        <span class="badge bg-${getRiskLevelClass(recommendation.risk_level)}">${recommendation.risk_level}</span>
                    </div>
                ` : ''}
            `;
        }

        function updateAIAnalysis(analysis) {
            const container = document.getElementById('aiAnalysis');
            if (!container || !analysis) return;
            
            container.innerHTML = `
                <div class="row mb-3">
                    <div class="col-6">
                        <strong>Trend:</strong> ${analysis.trend}
                    </div>
                    <div class="col-6">
                        <strong>Strength:</strong> ${analysis.strength}
                    </div>
                </div>
                <div class="mb-3">
                    <strong>Key Factors:</strong>
                    <ul class="mt-2 mb-3">
                        ${analysis.key_factors.map(factor => `<li><small>${factor}</small></li>`).join('')}
                    </ul>
                </div>
                <div class="row small">
                    <div class="col-6">
                        <strong>Model:</strong> ${analysis.model_used}
                    </div>
                    <div class="col-6">
                        <strong>Data Quality:</strong> ${analysis.data_quality}
                    </div>
                </div>
            `;
        }

        function updateSentimentAnalysis(sentiment) {
            const container = document.getElementById('sentimentAnalysis');
            if (!container || !sentiment) return;
            
            const sentimentClass = sentiment.overall_sentiment.toLowerCase() === 'positive' ? 'text-success' :
                                  sentiment.overall_sentiment.toLowerCase() === 'negative' ? 'text-danger' : 'text-warning';
            
            container.innerHTML = `
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="text-center">
                            <div class="h4 ${sentimentClass}">${sentiment.overall_sentiment}</div>
                            <div class="small">Overall Sentiment</div>
                            <div class="small text-muted">Score: ${sentiment.sentiment_score}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="small mb-2">
                            <strong>News:</strong> ${sentiment.news_sentiment}<br>
                            <strong>Social:</strong> ${sentiment.social_sentiment}
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <strong>Key Themes:</strong>
                    <div class="mt-2">
                        ${sentiment.key_themes.map(theme => 
                            `<span class="badge bg-secondary me-1 mb-1">${theme}</span>`
                        ).join('')}
                    </div>
                </div>
                <div class="small text-muted">
                    <strong>Sources:</strong> ${sentiment.sentiment_sources.join(', ')}
                </div>
            `;
        }

        function getRecommendationClass(recommendation) {
            const rec = recommendation.toLowerCase();
            if (rec.includes('buy')) return 'bg-success';
            if (rec.includes('sell')) return 'bg-danger';
            if (rec.includes('hold')) return 'bg-warning';
            return 'bg-secondary';
        }

        function getRiskLevelClass(riskLevel) {
            const risk = riskLevel.toLowerCase();
            if (risk === 'high') return 'danger';
            if (risk === 'medium') return 'warning';
            if (risk === 'low') return 'success';
            return 'secondary';
        }

        function showToast(title, message, type = 'info') {
            const toast = document.getElementById('notificationToast');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            
            if (!toast) return;
            
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            
            // Reset classes
            toast.className = 'toast';
            
            // Add type-specific classes
            if (type === 'success') {
                toast.classList.add('bg-success', 'text-white');
            } else if (type === 'error') {
                toast.classList.add('bg-danger', 'text-white');
            } else if (type === 'warning') {
                toast.classList.add('bg-warning', 'text-dark');
            } else {
                toast.classList.add('bg-info', 'text-white');
            }
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

        function updateChartsForTheme() {
            if (predictionChart) {
                const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                const textColor = isDark ? '#ffffff' : '#212529';
                const gridColor = isDark ? '#404040' : '#dee2e6';
                
                predictionChart.options.plugins.legend.labels.color = textColor;
                predictionChart.options.scales.x.ticks.color = textColor;
                predictionChart.options.scales.x.grid.color = gridColor;
                predictionChart.options.scales.y.ticks.color = textColor;
                predictionChart.options.scales.y.grid.color = gridColor;
                predictionChart.update();
            }
            
            if (technicalChart) {
                const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                const textColor = isDark ? '#ffffff' : '#212529';
                const gridColor = isDark ? '#404040' : '#dee2e6';
                
                technicalChart.options.plugins.legend.labels.color = textColor;
                technicalChart.options.scales.x.ticks.color = textColor;
                technicalChart.options.scales.x.grid.color = gridColor;
                technicalChart.options.scales.y.ticks.color = textColor;
                technicalChart.options.scales.y.grid.color = gridColor;
                technicalChart.update();
            }
        }

        // Utility: download chart PNG
        function downloadChart(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const link = document.createElement('a');
            link.download = `${canvasId}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        // Logout function
        async function logout() {
            try {
                const response = await fetch('/api/logout', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (response.ok) {
                    window.location.href = '/';
                } else {
                    console.error('Logout failed');
                }
            } catch (error) {
                console.error('Logout failed:', error);
                window.location.href = '/';
            }
        }
    </script>
</body>
</html>